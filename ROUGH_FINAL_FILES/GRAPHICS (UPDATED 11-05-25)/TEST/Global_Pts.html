<!DOCTYPE html>
<!-- @noSnoop -->
<html lang="en" xmlns:b="http://www.tridium.com/baja/baja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Murphy Control Panel - Global Variables Manager</title>

<!-- Add RequireJS and BajaScript Support -->
<script type='text/javascript' src='/requirejs/config.js'></script>
<script type='text/javascript' src='/module/js/com/tridium/js/ext/require/require.min.js?'></script>

<style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        /* Configuration Modal */
        .config-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .config-form {
            background: rgb(7, 74, 101);
            border-radius: 12px;
            padding: 30px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .config-form h2 {
            color: #ffffff;
            margin-bottom: 25px;
            font-size: 28px;
            text-align: center;
            border-bottom: 3px solid #00ff11;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #fafafa;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #66ea71;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .help-text {
            font-size: 12px;
            color: #000000;
            margin-top: 5px;
            font-style: italic;
        }

        .device-selection-section, .point-addition-section {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            border-left: 4px solid #667eea;
        }

        .device-selection-section h3, .point-addition-section h3 {
            color: #00ff11;
            margin-bottom: 15px;
            font-size: 20px;
        }

        .device-selector-row, .point-input-row {
            display: grid;
            gap: 15px;
            align-items: end;
            margin-bottom: 15px;
        }

        .device-selector-row {
            grid-template-columns: 1fr 150px auto;
        }

        .point-input-row {
            grid-template-columns: 1fr auto auto;
        }

        .device-name-field, .device-count-field, .device-selector-field, .point-input-field {
            display: flex;
            flex-direction: column;
        }

        .config-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .config-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .config-btn:active {
            transform: translateY(0);
        }

        .config-btn.primary {
            background: linear-gradient(135deg, #354f36,#2aa132, #00ff11);
            color: white;
        }

        .config-btn.secondary {
            background: linear-gradient(135deg, #a9b1a9,#8b958b, #343634);
            color: #ffffff;
        }

        .config-btn.success {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
        }

        .config-btn.danger {
            background: linear-gradient(135deg, #464343,#d54a4a, #ef2c2c);
            color: white;
        }

        .config-btn.warning {
            background: linear-gradient(135deg, #ed8936, #dd6b20);
            color: white;
        }

        .config-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        .device-creation-preview {
            background: #edf2f7;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }

        .preview-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #4a5568;
        }

        .preview-devices {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .preview-device-tag {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .bulk-point-indicator {
            background: #bee3f8;
            border: 1px solid #90cdf4;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
            color: #2b6cb0;
            font-weight: 500;
            text-align: center;
        }

        .selected-devices-count {
            font-weight: 700;
            color: #2b6cb0;
        }

        .connection-status {
            margin-top: 8px;
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: 500;
            text-align: center;
            font-size: 13px;
        }

        .connection-status.testing {
            background: #fef5e7;
            color: #c05621;
        }

        .connection-status.connected {
            background: #f0fff4;
            color: #276749;
        }

        .connection-status.failed {
            background: #fed7d7;
            color: #c53030;
        }

        .device-points-list {
            border: 2px solid #005acf;
            border-radius: 8px;
            background: #f8fafc;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .device-header {
            background: #667eea;
            color: white;
            padding: 12px 15px;
            margin: -5px -5px 10px -5px;
            border-radius: 6px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .point-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #e2e8f0;
            background: white;
            border-radius: 6px;
            margin-bottom: 5px;
        }

        .point-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }

        .point-name-display {
            font-weight: 500;
            color: #2d3748;
        }

        .point-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .point-status.connected {
            background: #c6f6d5;
            color: #276749;
        }

        .point-status.error {
            background: #fed7d7;
            color: #c53030;
        }

        .remove-point-btn {
            background: #f56565;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .remove-point-btn:hover {
            background: #e53e3e;
            transform: scale(1.05);
        }

        .json-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #e2e8f0;
        }

        .message {
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            font-weight: 500;
        }

        .message.success {
            background: #f0fff4;
            color: #276749;
            border: 1px solid #9ae6b4;
        }

        .message.error {
            background: #fed7d7;
            color: #c53030;
            border: 1px solid #feb2b2;
        }

        .message.warning {
            background: #fef5e7;
            color: #c05621;
            border: 1px solid #f6e05e;
        }

        .message.info {
            background: #bee3f8;
            color: #2b6cb0;
            border: 1px solid #90cdf4;
        }

        .hidden {
            display: none !important;
        }

        /* Main Content Styles */
        .main-content {
            padding: 40px 20px;
            text-align: center;
        }

        .config-reopen-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
        }

        .config-reopen-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(102, 126, 234, 0.4);
        }

        .welcome-message {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 40px;
            margin-top: 40px;
            color: white;
            text-align: center;
        }

        .welcome-message h1 {
            font-size: 32px;
            margin-bottom: 20px;
        }

        .welcome-message p {
            font-size: 18px;
            opacity: 0.9;
            line-height: 1.6;
        }

        @media (max-width: 768px) {
            .device-selector-row, .point-input-row {
                grid-template-columns: 1fr;
            }
            
            .json-actions {
                grid-template-columns: 1fr;
            }
            
            .config-form {
                padding: 20px;
                width: 95%;
            }
            
            .welcome-message h1 {
                font-size: 24px;
            }
            
            .welcome-message p {
                font-size: 16px;
            }

        }





/* Add styles for the logging section */
.logging-section {
    margin: 15px 0;
    padding: 12px;
    background-color: #f8f9fa;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
}

.checkbox-group {
    display: flex;
    align-items: flex-start;
    gap: 8px;

}

.checkbox-group input[type="checkbox"] {
    margin-top: 2px;
    transform: scale(1.1);
    cursor: pointer;

}

.checkbox-group label {
    font-weight: 500;
    color: #2d3748;
    cursor: pointer;
    margin-bottom: 0;
}

.checkbox-group .help-text {
    margin-left: 0;
    margin-top: 4px;
    font-size: 12px;
    color: #ffffff;
    font-style: italic;
    flex-basis: 100%;
}

/* Ensure proper spacing in point addition section */
.point-addition-section > * {
    margin-bottom: 15px;
        color: white;
    font-weight: bold;
}

.point-addition-section > *:last-child {
    margin-bottom: 0;
}



.category-points {
    display: none !important;
}

.hidden {
    display: none;
}

.point-input-field label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
}

.point-input-field select,
.point-input-field input {
    width: 100%;
    padding: 8px;
    margin-bottom: 15px;
    border: 1px solid #ccc;
    border-radius: 4px;
}

.point-input-field select:disabled {
    background-color: #f5f5f5;
    color: #6d5c5c;
    cursor: not-allowed;
}





  .form-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #dee2e6;
        }
        
        .form-section h2 {
            margin-top: 0;
            color: #495057;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .driver-path-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            background: white;
            border-radius: 5px;
            border: 1px solid #e9ecef;
        }
        
        .driver-path-item input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-family: monospace;
            margin-right: 10px;
        }
        
        .remove-driver-btn {
            background: #966f73;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            min-width: 70px;
        }
        
        .remove-driver-btn:hover {
            background: #c82333;
        }
        
        .add-driver-btn {
            background: linear-gradient(135deg, #1d4949,#207b7e, #1da1b3, #0ddddd);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }
        
        .add-driver-btn:hover {
            background: linear-gradient(135deg, #102424,#144c4e, #0f535c, #089797);
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #fdfdfd;
        }
        
        .driver-paths-container {
            margin-top: 15px;
        }
        
        .no-drivers-message {
            color: #6c757d;
            font-style: italic;
            padding: 20px;
            text-align: center;
            background: white;
            border-radius: 4px;
            border: 1px dashed #ced4da;
        }



        
        .driver-path-item input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-family: monospace;
            margin-right: 10px;
        }
        
        .remove-driver-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            min-width: 70px;
        }
        
        .add-driver-btn, .lock-drivers-btn {
            background: linear-gradient(135deg, #1d4949,#207b7e, #1da1b3, #0ddddd);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }
        
        .lock-drivers-btn {
            background: linear-gradient(135deg, #14b31a,#2aa132, #26c531, #00ff11);
        }
        
        .lock-drivers-btn:hover {
            background: linear-gradient(135deg, #0b4e0e,#1b6120, #1b8d23, #109b1a);
        }
        
        .driver-selection-section {
            margin-bottom: 20px;
        }
        
        .driver-selection-disabled {
            opacity: 0.5;
            pointer-events: none;
        }
        
        .form-content {
            transition: opacity 0.3s ease;
        }
        
        .form-content.disabled {
            opacity: 0.4;
            pointer-events: none;
        }
        
        .message {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        .message.success { background: #d4edda; color: #155724; }
        .message.error { background: #f8d7da; color: #721c24; }
        .message.warning { background: #fff3cd; color: #856404; }
        .message.info { background: #d1ecf1; color: #0c5460; }
        
        .hidden { display: none; }
        
        /* .config-btn {
            padding: 10px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        
        .config-btn.primary { background: #007bff; color: white; }
        .config-btn.secondary { background: #6c757d; color: white; }
        .config-btn.success { background: #28a745; color: white; }
        .config-btn.danger { background: #dc3545; color: white; }
         */
        select, input[type="text"], input[type="number"] {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .device-points-list {
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            background: #f8f9fa;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .device-header {
            font-weight: bold;
            padding: 10px;
            background: #e9ecef;
            border-radius: 4px;
            margin-bottom: 5px;
        }
        
        .point-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            margin-bottom: 5px;
        }
        
        .point-info {
            display: flex;
            flex-direction: column;
        }
        
        .point-name-display {
            font-weight: 500;
        }
        
        .point-status {
            font-size: 0.9em;
            color: #919191;
        }
        
        .remove-point-btn {
            background: #c7c7c7;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .driver-selector {
            margin-bottom: 20px;
            padding: 15px;
            background: #fff3cd;
            border: 2px solid #ffeaa7;
            border-radius: 8px;
        }
        
        .driver-selector h3 {
            margin-top: 0;
            color: #856404;
        }
        
        .driver-selector select {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            border: 2px solid #969696;
        }
        
        .help-text {
            font-size: 0.9em;
            color: #6200ff;
            margin-top: 5px;
        }
        
        .device-selection-section, .point-addition-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            background: #f8f9fa;
        }
        
        .logging-section {
            margin-bottom: 20px;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
        }
        
        .device-selector-row, .point-input-row {
            display: flex;
            align-items: end;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .device-name-field, .device-count-field, .device-selector-field, .point-input-field {
            flex: 1;
        }
        
        .json-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        
        .drop-zone {
  border: 2px dashed #114da8;
  border-radius: 8px;
  padding: 15px;
  text-align: center;
  color: #aa0000;
  margin-top: 10px;
  background: #f9f9f9;
}

.drop-zone.drag-over {
  border-color: #3182ce;
  background: #ebf8ff;
}

    </style>
</head>
<body>
    <!-- Configuration Modal -->
    <div id="configModal" class="config-modal">
        <div class="config-form">
            <h2>Graphics Points</h2>
            <form id="configForm">
                <!-- Driver Path Configuration -->
                <div class="form-group">
                    <label>Driver File Path Templates:</label>
                    <div id="driverPathsContainer" class="driver-paths-container">
                        <div class="driver-path-item">
                            <input type="text" class="driver-path-input" value="station:|slot:/Drivers/BcpBacnetNetwork/{headerName}/points/{pointName}" placeholder="Enter driver file path template">
                            <button type="button" class="remove-driver-btn" onclick="removeDriverPath(this)">Remove</button>
                        </div>
                    </div>
                    <button type="button" class="add-driver-btn" onclick="addDriverPath()">Add Drivers</button>
                    <button type="button" class="lock-drivers-btn" onclick="lockDriverPaths()">Lock Drivers</button>
                    <div id="driverMessage" class="message hidden"></div>
                </div>

                <!-- Driver Selection Section -->
                <div id="driverSelector" class="driver-selector hidden">
                    <h3>Select Driver Path</h3>
                    <select id="selectedDriverPath">
                        <option value="">-- Select a driver path --</option>
                    </select>
                    <div class="help-text">Choose which driver path to use for your configuration</div>
                </div>

                <!-- Form Content (disabled until driver selected) -->
                <div id="formContent" class="form-content disabled">
                    <!-- Device Selection Section -->
                    <div class="device-selection-section">
                        <h3 style="color: #333; margin-bottom: 15px;">Create Units</h3>
                        
                        <div class="device-selector-row">
                            <div class="device-name-field">
                                <label for="newDeviceName">Unit Declaration:</label>
                                <input type="text" id="newDeviceName" name="newDeviceName" 
                                       placeholder="Enter Unit name (e.g., AHU_1, VAV_0_1)" />
                                <div class="help-text">For numbered sequences use underscores, _X. X = unit number (e.g., AHU_1)</div>
                            </div>
                            <div class="device-count-field">
                                <label for="deviceCount">How Many Units:</label>
                                <input type="number" id="deviceCount" name="deviceCount" 
                                       min="1" max="120" value="1" 
                                       placeholder="1" />
                                <div class="help-text">Number of sequential units</div>
                            </div>
                            <button type="button" id="createDeviceBtn" class="config-btn success new-device-btn">Create Device(s)</button>
                        </div>
                        
                        <div id="deviceCreationPreview" class="device-creation-preview hidden">
                            <div class="preview-title">Devices to be created:</div>
                            <div id="previewDevicesList" class="preview-devices"></div>
                        </div>
                        
                        
                        

                        
                        
                        
                        
                        <div class="device-selector-row">
                            <div class="device-selector-field">
                                <label for="deviceSelector">Select Device for Individual Point Assigning:</label>
                                <select id="deviceSelector" name="deviceSelector">
                                    <option value="">-- Select a device --</option>
                                </select>
                            </div>
                        </div>
    
                        <div id="deviceMessage" class="message hidden"></div>
                    </div>

                    <!-- Point Addition Section -->
                    <div class="point-addition-section">
                        <h3 style="color: #333; margin-bottom: 15px;">Add Data Points</h3>
                        
                        <div id="bulkPointIndicator" class="bulk-point-indicator hidden">
                            Adding point to <span id="selectedDevicesCount" class="selected-devices-count">0</span> selected devices
                        </div>

                        <!-- Logging Checkbox Section -->
                        <div class="logging-section">
                            <div class="checkbox-group">
                                <input type="checkbox" id="enableNumericLogging" name="enableNumericLogging" />
                                <label for="enableNumericLogging">Enable Numeric Logging</label>
                                <div class="help-text">Check to enable numeric data logging</div>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="enableBooleanLogging" name="enableBooleanLogging" />
                                <label for="enableBooleanLogging">Enable Boolean Logging</label>
                                <div class="help-text">Check to enable boolean data logging</div>
                            </div>
                        </div>
                        
                        <div class="point-input-row">
                            <div class="point-input-field">
                                <label for="pointName">Point Name:</label>
                                <input type="text" id="pointName" name="pointName" 
                                       placeholder="Enter point name (e.g., DischargeAirTemp)" />
                                <div id="connectionStatus" class="connection-status hidden"></div>
                                
                                <label for="equipmentCategory">Equipment Category:</label>
                                <select id="equipmentCategory">
                                    <option value="">Select Category</option>
                                    <option value="ahu-rtu">AHU/RTU</option>
                                    <option value="vav">VAVs</option>
                                    <option value="chiller">Chillers</option>
                                    <option value="tower">Towers</option>
                                </select>
                                
                                <label for="pointId">Point ID:</label>
                                <select id="pointId" disabled>
                                    <option value="N/A">Select category first</option>
                                </select>
                                
                                <!-- Hidden dropdowns for each category -->
                                <select id="ahuRtuPoints" class="category-points hidden">
                                  <option value="N/A" selected>N/A</option>
                                  <option value="SP-Boolean">SP Boolean</option>
                                  <option value="SP-Numeric">SP Numeric</option>
                                  <option value="AHU-ALARM">AHU Alarm</option>
                                  <option value="DA-T">Discharge Air Temp</option>
                                  <option value="Static">Discharge Static</option>
                                  <option value="DPR-cmd">Damper Position</option>
                                  <option value="Fan-Stat">Fan Stat</option>
                                  <option value="OA-T">Outside Air</option>
                                  <option value="Occupancy">Occupancy Status</option>
                                </select>

                                
                                <select id="vavPoints" class="category-points hidden">
                                  <option value="N/A" selected>N/A</option>
                                  <option value="SP-Boolean">SP Boolean</option>
                                  <option value="SP-Numeric">SP Numeric</option>
                                  <option value="Air-Flow">Air Flow</option>
                                  <option value="DA-T">Discharge Air TMP</option>
                                  <option value="DPR-cmd">Damper CMD</option>
                                  <option value="DPR-Pos">Damper Pos</option>
                                  <option value="Occupancy">Occupancy</option>
                                  <option value="Reheat1">Reheat Stat</option>
                                  <option value="Space-Temp">Space Temp</option>
                                  <option value="HVACModeStatus">System Status (ON/OFF)</option>
                                  <option value="Mode">System Mode</option>
                                </select>

                                
                                <select id="chillerPoints" class="category-points hidden">
                                    <option value="N/A" selected>N/A</option>
                                    <option value="SP-Numeric">SP Numeric</option>
                                    <option value="SP-Boolean">SP Boolean</option>
                                    <option value="CH-ALM">Chiller Alarm</option>
                                    <option value="CH-CMD">Chiller Command</option>
                                    <option value="CH-EN">Chiller Enable</option>
                                    <option value="CH-ST">Chiller Status</option>
                                    <option value="CH-CondPMP">Condenser Water Pump</option>
                                    <option value="CH-LEAD">Lead Chiller</option>
                                    <option value="CH-PriCondPMP">Primary Condenser Pump</option>

                                </select>
                                
                                <select id="towerPoints" class="category-points hidden">
                                    <option value="N/A" selected>N/A</option>
                                    <option value="SP-Numeric">SP Numeric</option>
                                    <option value="SP-Boolean">SP Boolean</option>
                                    <option value="CH-ST">Chiller Stat</option>
                                    <option value="TMP-ENT">Entering Temperature</option>
                                    <option value="RTN-PMP">Return PMP Status </option>
                                    <option value="SUP-PMP">Supplt PMP Status</option>
                                    <option value="FAN-EN">Fan Enable</option>
                                    <option value="TMP-LEAVE">Leaving Tower Temp</option>

                                </select>
                                
                                <div class="help-text">Keep as N/A if not on list.</div>
                            </div>
                            <button type="button" id="testPointBtn" class="config-btn secondary">Test Connection</button>
                            <button type="button" id="savePointBtn" class="config-btn success" disabled>Save Point</button>
                        </div>

                        <div id="pointMessage" class="message hidden"></div>
                    </div>

                    <!-- Current Configuration Display -->
                    <div class="form-group">
                        <label>Current Graphics Points Configuration:</label>
                        <div id="globalVarsList" class="device-points-list">
                            <div style="text-align: center; color: #718096; font-style: italic;">No devices configured yet</div>
                        </div>
                    </div>
                    
                    <!-- JSON Management Actions -->
                    <div class="json-actions">
                        <button type="button" id="downloadJsonBtn" class="config-btn primary">Download JSON</button>
                        <button type="button" id="loadJsonBtn" class="config-btn secondary">Load JSON</button>
                        <button type="button" id="clearAllBtn" class="config-btn danger">Clear All</button>
                    </div>
                    <input type="file" id="jsonFileInput" accept=".json" style="display: none;" />
                </div>
            </form>
        </div>
    </div>









    <script>
        // Global Variables JSON Structure
        let globalVariablesConfig = {
            driverPaths: [],
            selectedDriverPath: '',
            globalVariables: {},
            metadata: {
                version: "1.0",
                lastModified: new Date().toISOString(),
                totalDevices: 0,
                totalPoints: 0
            }
        };

        let currentDevice = null;
        let lastTestedPoint = null;
        let selectedDevices = [];
        let driversLocked = false;

        // DOM Elements
        const configModal = document.getElementById('configModal');
        const driverSelector = document.getElementById('driverSelector');
        const selectedDriverPath = document.getElementById('selectedDriverPath');
        const formContent = document.getElementById('formContent');
        const deviceSelector = document.getElementById('deviceSelector');
        const newDeviceName = document.getElementById('newDeviceName');
        const deviceCount = document.getElementById('deviceCount');
        const createDeviceBtn = document.getElementById('createDeviceBtn');
        const deviceCreationPreview = document.getElementById('deviceCreationPreview');
        const previewDevicesList = document.getElementById('previewDevicesList');
        const pointNameInput = document.getElementById('pointName');
        const testPointBtn = document.getElementById('testPointBtn');
        const savePointBtn = document.getElementById('savePointBtn');
        const globalVarsList = document.getElementById('globalVarsList');
        const connectionStatus = document.getElementById('connectionStatus');
        const deviceMessage = document.getElementById('deviceMessage');
        const pointMessage = document.getElementById('pointMessage');
        const bulkPointIndicator = document.getElementById('bulkPointIndicator');
        const selectedDevicesCount = document.getElementById('selectedDevicesCount');
        const enableNumericLoggingCheckbox = document.getElementById('enableNumericLogging');
        const enableBooleanLoggingCheckbox = document.getElementById('enableBooleanLogging');
        const driverMessage = document.getElementById('driverMessage');



        // Driver Path Management Functions
        function addDriverPath() {
            const container = document.getElementById('driverPathsContainer');
            const newItem = document.createElement('div');
            newItem.className = 'driver-path-item';
            
            const defaultPath = 'station:|slot:/Drivers/BcpBacnetNetwork/{headerName}/points/{pointName}';
            
            newItem.innerHTML = `
                <input type="text" class="driver-path-input" value="${defaultPath}" placeholder="Enter driver file path template">
                <button type="button" class="remove-driver-btn" onclick="removeDriverPath(this)">Remove</button>
            `;
            
            container.appendChild(newItem);
            
            const newInput = newItem.querySelector('.driver-path-input');
            newInput.focus();
            newInput.select();
        }

        function removeDriverPath(button) {
            const container = document.getElementById('driverPathsContainer');
            const item = button.parentElement;
            
            if (container.children.length <= 1) {
                showDriverMessage('You must have at least one driver path configured.', 'error');
                return;
            }
            
            item.remove();
        }

        function getAllDriverPaths() {
            const inputs = document.querySelectorAll('.driver-path-input');
            return Array.from(inputs).map(input => input.value.trim()).filter(path => path !== '');
        }

        function lockDriverPaths() {
            const driverPaths = getAllDriverPaths();
            
            if (driverPaths.length === 0) {
                showDriverMessage('Please add at least one driver path before locking.', 'error');
                return;
            }

            // Save driver paths to config
            globalVariablesConfig.driverPaths = driverPaths;
            driversLocked = true;

            // Disable driver path editing
            const container = document.getElementById('driverPathsContainer');
            container.classList.add('driver-selection-disabled');
            document.querySelector('.add-driver-btn').disabled = true;
            document.querySelector('.lock-drivers-btn').disabled = true;

            // Show driver selector
            populateDriverSelector(driverPaths);
            driverSelector.classList.remove('hidden');

            showDriverMessage(`${driverPaths.length} driver paths locked. Please select one to continue.`, 'success');
        }

        function populateDriverSelector(driverPaths) {
            selectedDriverPath.innerHTML = '<option value="">-- Select a driver path --</option>';
            
            driverPaths.forEach((path, index) => {
                const option = document.createElement('option');
                option.value = path;
                // Extract driver type for display
                const match = path.match(/\/Drivers\/([^\/]+)\//);
                const driverType = match ? match[1] : `Path ${index + 1}`;
                option.textContent = `${driverType}: ${path}`;
                selectedDriverPath.appendChild(option);
            });

            selectedDriverPath.addEventListener('change', function() {
                if (this.value) {
                    globalVariablesConfig.selectedDriverPath = this.value;
                    formContent.classList.remove('disabled');
                    showDriverMessage(`Selected driver path: ${this.value}`, 'info');
                } else {
                    globalVariablesConfig.selectedDriverPath = '';
                    formContent.classList.add('disabled');
                }
            });
        }

        function showDriverMessage(message, type) {
            driverMessage.textContent = message;
            driverMessage.className = `message ${type}`;
            driverMessage.classList.remove('hidden');
            
            setTimeout(() => {
                driverMessage.classList.add('hidden');
            }, 5000);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Graphics Points Configuration - Initializing...');
            
            updateDeviceSelector();
            updateGlobalVarsDisplay();
            
            if (Object.keys(globalVariablesConfig.globalVariables).length === 0) {
                configModal.classList.remove('hidden');
                showDeviceMessage('Welcome! First, add and lock your driver paths, then create your first device.', 'info');
            } else {
                configModal.classList.add('hidden');
            }

            // Add category selection handler
            setupCategorySelection();
        });

        // Category selection setup
        function setupCategorySelection() {
            const categorySelect = document.getElementById('equipmentCategory');
            const pointIdSelect = document.getElementById('pointId');
            
            const categoryPoints = {
                'ahu-rtu': document.getElementById('ahuRtuPoints'),
                'vav': document.getElementById('vavPoints'),
                'chiller': document.getElementById('chillerPoints'),
                'tower': document.getElementById('towerPoints')
            };
            
            categorySelect.addEventListener('change', function() {
                const selectedCategory = this.value;
                
                pointIdSelect.innerHTML = '<option value="N/A">N/A</option>';
                
                if (selectedCategory && categoryPoints[selectedCategory]) {
                    pointIdSelect.disabled = false;
                    
                    const categoryOptions = categoryPoints[selectedCategory].getElementsByTagName('option');
                    
                    for (let i = 0; i < categoryOptions.length; i++) {
                        const option = categoryOptions[i].cloneNode(true);
                        pointIdSelect.appendChild(option);
                    }
                } else {
                    pointIdSelect.disabled = true;
                    pointIdSelect.innerHTML = '<option value="N/A">Select category first</option>';
                }
            });
        }

        // Device creation preview
        newDeviceName.addEventListener('input', updateDevicePreview);
        deviceCount.addEventListener('input', updateDevicePreview);
        createDeviceBtn.addEventListener('click', createNewDevices);
        deviceSelector.addEventListener('change', selectDevice);
        testPointBtn.addEventListener('click', testPointConnection);
        savePointBtn.addEventListener('click', savePoint);
        document.getElementById('downloadJsonBtn').addEventListener('click', downloadJSON);
        document.getElementById('loadJsonBtn').addEventListener('click', () => {
            document.getElementById('jsonFileInput').click();
        });
        document.getElementById('jsonFileInput').addEventListener('change', loadJSON);
        document.getElementById('clearAllBtn').addEventListener('click', clearAllData);

        function updateDevicePreview() {
            const deviceName = newDeviceName.value.trim();
            const count = parseInt(deviceCount.value) || 1;
            
            if (!deviceName || count < 1) {
                deviceCreationPreview.classList.add('hidden');
                return;
            }
            
            const deviceNames = generateDeviceNames(deviceName, count);
            
            if (deviceNames.length > 0) {
                previewDevicesList.innerHTML = deviceNames
                    .map(name => `<span class="preview-device-tag">${name}</span>`)
                    .join('');
                deviceCreationPreview.classList.remove('hidden');
            } else {
                deviceCreationPreview.classList.add('hidden');
            }
        }

        function generateDeviceNames(baseName, count) {
            const deviceNames = [];
            
            if (count === 1) {
                deviceNames.push(baseName);
                return deviceNames;
            }
            
            const match = baseName.match(/^(.+?)(\d+)$/);
            
            if (match) {
                const prefix = match[1];
                const startNumber = parseInt(match[2]);
                
                for (let i = 0; i < count; i++) {
                    deviceNames.push(`${prefix}${startNumber + i}`);
                }
            } else {
                for (let i = 1; i <= count; i++) {
                    if (i === 1) {
                        deviceNames.push(baseName);
                    } else {
                        deviceNames.push(`${baseName}_${i}`);
                    }
                }
            }
            
            return deviceNames;
        }


        function selectDevice() {
            const selectedDevice = deviceSelector.value;
            if (selectedDevice) {
                currentDevice = selectedDevice;
                selectedDevices = [selectedDevice];
                updateBulkPointIndicator();
                showDeviceMessage(`Selected device: ${selectedDevice}`, 'info');
                resetPointTesting();
            } else {
                currentDevice = null;
                selectedDevices = [];
                updateBulkPointIndicator();
            }
        }

        function updateBulkPointIndicator() {
            if (selectedDevices.length > 1) {
                selectedDevicesCount.textContent = selectedDevices.length;
                bulkPointIndicator.classList.remove('hidden');
            } else {
                bulkPointIndicator.classList.add('hidden');
            }
        }

        function testPointConnection() {
            if (selectedDevices.length === 0) {
                showPointMessage('Please select or create a device first', 'error');
                return;
            }
            
            const pointName = pointNameInput.value.trim();
            if (!pointName) {
                showPointMessage('Please enter a point name', 'error');
                return;
            }
            
            if (!validatePointName(pointName)) {
                showPointMessage('Point name must start with a letter and contain only letters, numbers, and underscores', 'error');
                return;
            }
            
            connectionStatus.textContent = 'Testing connection...';
            connectionStatus.className = 'connection-status testing';
            connectionStatus.classList.remove('hidden');
            testPointBtn.disabled = true;
            
            const testDuration = 1000 + Math.random() * 2000;
            
            setTimeout(() => {
                const isConnected = Math.random() > 0.25;
                
                if (isConnected) {
                    connectionStatus.textContent = 'Connected ✓';
                    connectionStatus.className = 'connection-status connected';
                    
                    const deviceList = selectedDevices.length > 1 ? 
                        `${selectedDevices.length} devices (${selectedDevices[0]}, ...)` : 
                        selectedDevices[0];
                    
                    showPointMessage(`Successfully connected to ${deviceList}/${pointName}`, 'success');
                    savePointBtn.disabled = false;
                    lastTestedPoint = {
                        name: pointName,
                        status: 'connected',
                        dateAdded: new Date().toISOString()
                    };
                } else {
                    connectionStatus.textContent = 'Connection Failed ✗';
                    connectionStatus.className = 'connection-status failed';
                    showPointMessage(`Failed to connect to ${pointName}. Check point name and path.`, 'error');
                    savePointBtn.disabled = true;
                    lastTestedPoint = null;
                }
                
                testPointBtn.disabled = false;
            }, testDuration);
        }

        function getLoggingValues() {
            const isNumericLoggingEnabled = enableNumericLoggingCheckbox.checked;
            const isBooleanLoggingEnabled = enableBooleanLoggingCheckbox.checked;
            
            return {
                logNumeric: isNumericLoggingEnabled ? "yes_Numeric" : "no_Numeric",
                logBoolean: isBooleanLoggingEnabled ? "yes_Boolean" : "no_Boolean"
            };
        }

        function savePoint() {
            if (!lastTestedPoint || selectedDevices.length === 0) {
                showPointMessage('Please test the connection first', 'error');
                return;
            }
            
            const pointName = lastTestedPoint.name;
            const pointId = document.getElementById('pointId').value;
            const loggingValues = getLoggingValues();
            const devicesWithExistingPoint = [];
            const devicesForNewPoint = [];
            
            selectedDevices.forEach(deviceName => {
                const deviceConfig = globalVariablesConfig.globalVariables[deviceName];
                const existingPoint = deviceConfig.points.find(p => p.name === pointName);
                
                if (existingPoint) {
                    devicesWithExistingPoint.push(deviceName);
                } else {
                    devicesForNewPoint.push(deviceName);
                }
            });
            
            devicesForNewPoint.forEach(deviceName => {
                const deviceConfig = globalVariablesConfig.globalVariables[deviceName];
                const pointData = {
                    name: pointName,
                    id: pointId,
                    fullPath: globalVariablesConfig.selectedDriverPath
                        .replace('{headerName}', deviceName)
                        .replace('{pointName}', pointName),
                    driverPath: globalVariablesConfig.selectedDriverPath,
                    status: lastTestedPoint.status,
                    logNumeric: loggingValues.logNumeric,
                    logBoolean: loggingValues.logBoolean,
                    dateAdded: new Date().toISOString()
                };
                deviceConfig.points.push(pointData);
            });
            
            if (devicesForNewPoint.length > 0) {
                updateMetadata();
                saveToLocalStorage();
                updateGlobalVarsDisplay();
            }
            
            if (devicesWithExistingPoint.length > 0) {
                showPointMessage(`Point "${pointName}" already exists in: ${devicesWithExistingPoint.join(', ')}`, 'warning');
            }
            
            if (devicesForNewPoint.length === 1) {
                showPointMessage(`Point "${pointName}" saved to ${devicesForNewPoint[0]}`, 'success');
            } else if (devicesForNewPoint.length > 1) {
                showPointMessage(`Point "${pointName}" saved to ${devicesForNewPoint.length} devices: ${devicesForNewPoint.join(', ')}`, 'success');
            }
            
            if (devicesForNewPoint.length === 0 && devicesWithExistingPoint.length > 0) {
                showPointMessage('No new points were added - all selected devices already have this point', 'info');
            }
            
            pointNameInput.value = '';
            document.getElementById('pointId').value = "N/A";
            document.getElementById('equipmentCategory').value = "";
            resetPointTesting();
        }

        function resetPointTesting() {
            connectionStatus.classList.add('hidden');
            savePointBtn.disabled = true;
            lastTestedPoint = null;
        }

        function removePoint(deviceName, pointName) {
            const deviceConfig = globalVariablesConfig.globalVariables[deviceName];
            deviceConfig.points = deviceConfig.points.filter(p => p.name !== pointName);
            
            updateMetadata();
            saveToLocalStorage();
            updateGlobalVarsDisplay();
            
            showPointMessage(`Point "${pointName}" removed from ${deviceName}`, 'info');
        }

        function updateDeviceSelector() {
            const devices = Object.keys(globalVariablesConfig.globalVariables).sort();
            deviceSelector.innerHTML = '<option value="">-- Select devices (hold Ctrl/Cmd for multiple) --</option>';
            
            deviceSelector.multiple = true;
            deviceSelector.size = Math.min(devices.length + 1, 8);
            
            devices.forEach(deviceName => {
                const option = document.createElement('option');
                option.value = deviceName;
                option.textContent = deviceName;
                deviceSelector.appendChild(option);
            });
            
            deviceSelector.removeEventListener('change', selectDevice);
            deviceSelector.addEventListener('change', function() {
                const selectedOptions = Array.from(deviceSelector.selectedOptions);
                selectedDevices = selectedOptions.map(option => option.value).filter(value => value !== '');
                
                if (selectedDevices.length === 1) {
                    currentDevice = selectedDevices[0];
                    showDeviceMessage(`Selected device: ${selectedDevices[0]}`, 'info');
                } else if (selectedDevices.length > 1) {
                    currentDevice = null;
                    showDeviceMessage(`Selected ${selectedDevices.length} devices: ${selectedDevices.join(', ')}`, 'info');
                } else {
                    currentDevice = null;
                    selectedDevices = [];
                    showDeviceMessage('No devices selected', 'info');
                }
                
                updateBulkPointIndicator();
                resetPointTesting();
            });
        }

        function updateGlobalVarsDisplay() {
            const devices = Object.keys(globalVariablesConfig.globalVariables).sort();
            
            if (devices.length === 0) {
                globalVarsList.innerHTML = '<div style="text-align: center; color: #718096; font-style: italic;">No devices configured yet</div>';
                return;
            }
            
            let html = '';
            devices.forEach(deviceName => {
                const deviceConfig = globalVariablesConfig.globalVariables[deviceName];
                const driverType = deviceConfig.driverPath ? deviceConfig.driverPath.match(/\/Drivers\/([^\/]+)\//)?.[1] || 'Unknown' : 'Legacy';
                
                html += `
                    <div class="device-header">
                        ${deviceName} (${deviceConfig.points.length} points) - Driver: ${driverType}
                        <button class="remove-point-btn" onclick="removeDevice('${deviceName}')" style="float: right; margin-top: -2px;">Remove Device</button>
                    </div>
                `;
                
                if (deviceConfig.points.length === 0) {
                    html += '<div style="padding: 10px; color: #718096; font-style: italic;">No points added yet</div>';
                } else {
                    deviceConfig.points.forEach(point => {
                        let logStatus = '';
                        if (point.logNumeric && point.logBoolean) {
                            logStatus = `(Num: ${point.logNumeric}, Bool: ${point.logBoolean})`;
                        } else if (point.log) {
                            logStatus = `(log: ${point.log})`;
                        }
                        
                        html += `
                            <div class="point-item">
                                <div class="point-info">
                                    <div class="point-name-display">${point.name} ${logStatus}</div>
                                    <div class="point-status ${point.status}">${point.status}</div>
                                </div>
                                <button class="remove-point-btn" onclick="removePoint('${deviceName}', '${point.name}')">Remove</button>
                            </div>
                        `;
                    });
                }
            });
            
            globalVarsList.innerHTML = html;
        }

        function removeDevice(deviceName) {
            if (confirm(`Are you sure you want to remove device "${deviceName}" and all its points?`)) {
                delete globalVariablesConfig.globalVariables[deviceName];
                
                selectedDevices = selectedDevices.filter(name => name !== deviceName);
                if (currentDevice === deviceName) {
                    currentDevice = null;
                    deviceSelector.value = '';
                }
                
                updateBulkPointIndicator();
                updateMetadata();
                saveToLocalStorage();
                updateDeviceSelector();
                updateGlobalVarsDisplay();
                
                showDeviceMessage(`Device "${deviceName}" removed successfully`, 'info');
            }
        }

        function updateMetadata() {
            const devices = Object.keys(globalVariablesConfig.globalVariables);
            let totalPoints = 0;
            
            devices.forEach(deviceName => {
                totalPoints += globalVariablesConfig.globalVariables[deviceName].points.length;
            });
            
            globalVariablesConfig.metadata = {
                version: "1.0",
                lastModified: new Date().toISOString(),
                totalDevices: devices.length,
                totalPoints: totalPoints
            };
        }

        function saveToLocalStorage() {
            const configStr = JSON.stringify(globalVariablesConfig, null, 2);
            console.log('Graphics Points Config Updated:', configStr);
            createAutoBackup();
        }

        function downloadJSON() {
            updateMetadata();
            const timestamp = new Date().toISOString().split('T')[0];
            const configStr = JSON.stringify(globalVariablesConfig, null, 2);
            const blob = new Blob([configStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `Global_${timestamp}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showDeviceMessage(`Configuration exported as Global_${timestamp}.json`, 'success');
        }

        function createAutoBackup() {
            const backupData = {
                ...globalVariablesConfig,
                backupInfo: {
                    type: "auto-backup",
                    timestamp: new Date().toISOString(),
                    trigger: "configuration_change"
                }
            };
            
            window.lastBackup = backupData;
            console.log('Auto-backup created:', new Date().toLocaleTimeString());
        }

        function loadJSON(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const loadedConfig = JSON.parse(e.target.result);
                    
                    if (loadedConfig.globalVariables && loadedConfig.metadata) {
                        if (Object.keys(globalVariablesConfig.globalVariables).length > 0) {
                            window.previousConfig = { ...globalVariablesConfig };
                            console.log('Previous configuration backed up before loading new JSON');
                        }
                        
                        globalVariablesConfig = loadedConfig;
                        
                        // Handle driver paths from loaded config
                        if (loadedConfig.driverPaths && loadedConfig.driverPaths.length > 0) {
                            // Restore driver paths
                            const container = document.getElementById('driverPathsContainer');
                            container.innerHTML = '';
                            
                            loadedConfig.driverPaths.forEach(path => {
                                const item = document.createElement('div');
                                item.className = 'driver-path-item';
                                item.innerHTML = `
                                    <input type="text" class="driver-path-input" value="${path}" placeholder="Enter driver file path template">
                                    <button type="button" class="remove-driver-btn" onclick="removeDriverPath(this)">Remove</button>
                                `;
                                container.appendChild(item);
                            });
                            
                            // Lock the drivers and show selector if there was a selected path
                            lockDriverPaths();
                            if (loadedConfig.selectedDriverPath) {
                                selectedDriverPath.value = loadedConfig.selectedDriverPath;
                                formContent.classList.remove('disabled');
                                showDriverMessage(`Loaded driver configuration. Selected path: ${loadedConfig.selectedDriverPath}`, 'info');
                            }
                        }
                        
                        updateDeviceSelector();
                        updateGlobalVarsDisplay();
                        currentDevice = null;
                        selectedDevices = [];
                        deviceSelector.value = '';
                        updateBulkPointIndicator();
                        resetPointTesting();
                        
                        showDeviceMessage(`JSON loaded: ${loadedConfig.metadata.totalDevices} devices, ${loadedConfig.metadata.totalPoints} points`, 'success');
                    } else {
                        throw new Error('Invalid JSON structure - missing globalVariables or metadata');
                    }
                } catch (error) {
                    showDeviceMessage('Error loading JSON: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);
            
            event.target.value = '';
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear all graphics points data? This cannot be undone.')) {
                globalVariablesConfig = {
                    driverPaths: [],
                    selectedDriverPath: '',
                    globalVariables: {},
                    metadata: {
                        version: "1.0",
                        lastModified: new Date().toISOString(),
                        totalDevices: 0,
                        totalPoints: 0
                    }
                };
                
                // Reset driver path interface
                const container = document.getElementById('driverPathsContainer');
                container.innerHTML = `
                    <div class="driver-path-item">
                        <input type="text" class="driver-path-input" value="station:|slot:/Drivers/BcpBacnetNetwork/{headerName}/points/{pointName}" placeholder="Enter driver file path template">
                        <button type="button" class="remove-driver-btn" onclick="removeDriverPath(this)">Remove</button>
                    </div>
                `;
                container.classList.remove('driver-selection-disabled');
                document.querySelector('.add-driver-btn').disabled = false;
                document.querySelector('.lock-drivers-btn').disabled = false;
                driverSelector.classList.add('hidden');
                formContent.classList.add('disabled');
                driversLocked = false;
                
                currentDevice = null;
                selectedDevices = [];
                updateDeviceSelector();
                updateGlobalVarsDisplay();
                updateBulkPointIndicator();
                resetPointTesting();
                
                showDeviceMessage('All data cleared successfully', 'info');
            }
        }

        function showDeviceMessage(message, type) {
            deviceMessage.textContent = message;
            deviceMessage.className = `message ${type}`;
            deviceMessage.classList.remove('hidden');
            
            setTimeout(() => {
                deviceMessage.classList.add('hidden');
            }, 5000);
        }

        function showPointMessage(message, type) {
            pointMessage.textContent = message;
            pointMessage.className = `message ${type}`;
            pointMessage.classList.remove('hidden');
            
            setTimeout(() => {
                pointMessage.classList.add('hidden');
            }, 5000);
        }

        function validatePointName(pointName) {
            const validPattern = /^[a-zA-Z][a-zA-Z0-9_]*$/;
            return validPattern.test(pointName);
        }

        console.log('Graphics Points Configuration - Loaded successfully');
        
        
        
        
        
        
        
        





// ========================= VAV REHEAT SELECTION =========================
// Create modal for VAV type selection with three columns
const vavModal = document.createElement("div");
vavModal.className = "config-modal hidden";
vavModal.innerHTML = `
  <div class="config-form" style="width: 90%; max-width: 1200px;">
    <h2>Select VAV Types</h2>
    <div style="margin-bottom: 15px;">
      <button id="clearAllVavBtn" class="config-btn" style="margin-right: 10px;">Clear All Selections</button>
      <span style="color: #333; font-size: 14px;">Select each unit in only one category</span>
    </div>
    
    <div style="display: flex; gap: 20px; margin-bottom: 20px;">
      <!-- Electric Reheat Column -->
      <div style="flex: 1; border: 1px solid #ddd; border-radius: 5px;">
        <div style="background-color: white; padding: 10px; border-bottom: 1px solid #ddd; text-align: center;">
          <h3 style="margin: 0; color: #2e7d32;">Electric Reheat</h3>
          <div style="margin-top: 5px;">
            <button class="column-select-all" data-type="HEAT" style="font-size: 12px; padding: 3px 8px; margin-right: 5px;">Select All</button>
            <button class="column-clear-all" data-type="HEAT" style="font-size: 12px; padding: 3px 8px;">Clear All</button>
          </div>
        </div>
        <div id="heatVavList" class="vav-column" style="max-height: 400px; overflow-y: auto; padding: 10px;"></div>
      </div>
      
      <!-- Fan Only Column -->
      <div style="flex: 1; border: 1px solid #ddd; border-radius: 5px;">
        <div style="background-color: white; padding: 10px; border-bottom: 1px solid #ddd; text-align: center;">
          <h3 style="margin: 0; color: #1565c0;">Fan Only</h3>
          <div style="margin-top: 5px;">
            <button class="column-select-all" data-type="FAN" style="font-size: 12px; padding: 3px 8px; margin-right: 5px;">Select All</button>
            <button class="column-clear-all" data-type="FAN" style="font-size: 12px; padding: 3px 8px;">Clear All</button>
          </div>
        </div>
        <div id="fanVavList" class="vav-column" style="max-height: 400px; overflow-y: auto; padding: 10px;"></div>
      </div>
      
      <!-- Fan With Electric Reheat Column -->
      <div style="flex: 1; border: 1px solid #ddd; border-radius: 5px;">
        <div style="background-color: white; padding: 10px; border-bottom: 1px solid #ddd; text-align: center;">
          <h3 style="margin: 0; color: #f57c00;">Fan With Electric Reheat</h3>
          <div style="margin-top: 5px;">
            <button class="column-select-all" data-type="FANR" style="font-size: 12px; padding: 3px 8px; margin-right: 5px;">Select All</button>
            <button class="column-clear-all" data-type="FANR" style="font-size: 12px; padding: 3px 8px;">Clear All</button>
          </div>
        </div>
        <div id="fanrVavList" class="vav-column" style="max-height: 400px; overflow-y: auto; padding: 10px;"></div>
      </div>
    </div>
    
    <div style="text-align: center; padding: 10px; background-color: white; border: 1px solid #ddd; border-radius: 3px; margin-bottom: 15px;">
      <span id="selectionSummary" style="font-size: 14px; color: #333;">No units selected</span>
    </div>
    
    <button id="confirmVavBtn" class="config-btn success">OK</button>
  </div>
`;
document.body.appendChild(vavModal);

const confirmVavBtn = vavModal.querySelector("#confirmVavBtn");
const clearAllVavBtn = vavModal.querySelector("#clearAllVavBtn");
const selectionSummary = vavModal.querySelector("#selectionSummary");
let pendingVavs = [];
let selectedVavs = {
  HEAT: new Set(),
  FAN: new Set(),
  FANR: new Set()
};

// Show VAV modal if new devices contain VAV
function handleVavSelection(devices) {
  const vavs = devices.filter(name => name.toUpperCase().includes("VAV"));
  if (vavs.length === 0) return proceedAfterVavSelection();
  
  pendingVavs = vavs;
  selectedVavs = { HEAT: new Set(), FAN: new Set(), FANR: new Set() };
  
  // Populate all three columns with the same VAV list
  populateVavColumn('heatVavList', vavs, 'HEAT');
  populateVavColumn('fanVavList', vavs, 'FAN');
  populateVavColumn('fanrVavList', vavs, 'FANR');
  
  // Set up event listeners for column buttons
  setupColumnButtons();
  
  // Update selection summary
  updateSelectionSummary();
  
  vavModal.classList.remove("hidden");
}

function populateVavColumn(containerId, vavs, type) {
  const container = document.getElementById(containerId);
  container.innerHTML = vavs.map(v =>
    `<div class="vav-item" data-device="${v}" data-type="${type}" 
          style="margin-bottom: 5px; padding: 8px; border-radius: 3px; cursor: pointer; user-select: none; transition: all 0.2s ease;">
       <input type="checkbox" id="chk_${type}_${v}" data-device="${v}" data-type="${type}" style="margin-right: 8px; pointer-events: none;">
       <label style="cursor: pointer; user-select: none; pointer-events: none; font-size: 14px;">${v}</label>
     </div>`
  ).join("");
  
  // Add click handlers for each item
  container.querySelectorAll('.vav-item').forEach(item => {
    item.addEventListener('click', function() {
      const deviceName = this.dataset.device;
      const deviceType = this.dataset.type;
      const checkbox = this.querySelector('input[type="checkbox"]');
      
      if (checkbox.checked) {
        // Unselect this item
        unselectVav(deviceName, deviceType);
      } else {
        // Select this item (and unselect from other columns if selected)
        selectVav(deviceName, deviceType);
      }
    });
    
    // Add hover effects
    item.addEventListener('mouseenter', function() {
      if (!this.querySelector('input[type="checkbox"]').checked) {
        this.style.backgroundColor = '#f0f0f0';
      }
    });
    
    item.addEventListener('mouseleave', function() {
      if (!this.querySelector('input[type="checkbox"]').checked) {
        this.style.backgroundColor = 'transparent';
      }
    });
  });
}

function selectVav(deviceName, type) {
  // Remove from all other categories first
  Object.keys(selectedVavs).forEach(otherType => {
    if (otherType !== type && selectedVavs[otherType].has(deviceName)) {
      selectedVavs[otherType].delete(deviceName);
      const otherCheckbox = document.getElementById(`chk_${otherType}_${deviceName}`);
      if (otherCheckbox) {
        otherCheckbox.checked = false;
        otherCheckbox.parentElement.style.backgroundColor = 'transparent';
      }
    }
  });
  
  // Add to the selected category
  selectedVavs[type].add(deviceName);
  const checkbox = document.getElementById(`chk_${type}_${deviceName}`);
  if (checkbox) {
    checkbox.checked = true;
    checkbox.parentElement.style.backgroundColor = getTypeColor(type);
  }
  
  updateSelectionSummary();
}

function unselectVav(deviceName, type) {
  selectedVavs[type].delete(deviceName);
  const checkbox = document.getElementById(`chk_${type}_${deviceName}`);
  if (checkbox) {
    checkbox.checked = false;
    checkbox.parentElement.style.backgroundColor = 'transparent';
  }
  
  updateSelectionSummary();
}

function getTypeColor(type) {
  switch(type) {
    case 'HEAT': return '#e8f5e8';
    case 'FAN': return '#e3f2fd';
    case 'FANR': return '#fff3e0';
    default: return '#f0f0f0';
  }
}

function setupColumnButtons() {
  // Column select all buttons
  document.querySelectorAll('.column-select-all').forEach(btn => {
    btn.addEventListener('click', function() {
      const type = this.dataset.type;
      pendingVavs.forEach(vav => {
        selectVav(vav, type);
      });
    });
  });
  
  // Column clear all buttons
  document.querySelectorAll('.column-clear-all').forEach(btn => {
    btn.addEventListener('click', function() {
      const type = this.dataset.type;
      selectedVavs[type].forEach(vav => {
        unselectVav(vav, type);
      });
    });
  });
  
  // Clear all selections button
  clearAllVavBtn.addEventListener('click', function() {
    Object.keys(selectedVavs).forEach(type => {
      selectedVavs[type].forEach(vav => {
        unselectVav(vav, type);
      });
    });
  });
}

function updateSelectionSummary() {
  const totalSelected = Object.values(selectedVavs).reduce((total, set) => total + set.size, 0);
  const totalVavs = pendingVavs.length;
  const unselected = totalVavs - totalSelected;
  
  let summaryText = '';
  if (totalSelected === 0) {
    summaryText = 'No units selected';
  } else {
    const parts = [];
    if (selectedVavs.HEAT.size > 0) parts.push(`${selectedVavs.HEAT.size} Electric Reheat`);
    if (selectedVavs.FAN.size > 0) parts.push(`${selectedVavs.FAN.size} Fan Only`);
    if (selectedVavs.FANR.size > 0) parts.push(`${selectedVavs.FANR.size} Fan + Electric Reheat`);
    
    summaryText = `Selected: ${parts.join(', ')}`;
    if (unselected > 0) {
      summaryText += ` | ${unselected} unassigned (will be set to N/A)`;
    }
  }
  
  selectionSummary.textContent = summaryText;
}

// Confirm button handler
confirmVavBtn.addEventListener("click", () => {
  pendingVavs.forEach(v => {
    let assignedType = "N/A"; // Default for unselected items
    
    // Check which category this VAV is selected in
    if (selectedVavs.HEAT.has(v)) {
      assignedType = "HEAT";
    } else if (selectedVavs.FAN.has(v)) {
      assignedType = "FAN";
    } else if (selectedVavs.FANR.has(v)) {
      assignedType = "FANR";
    }
    
    globalVariablesConfig.globalVariables[v].Type = assignedType;
  });
  
  vavModal.classList.add("hidden");
  proceedAfterVavSelection();
});

// Continue original flow
function proceedAfterVavSelection() {
  updateMetadata();
  saveToLocalStorage();
  updateDeviceSelector();
  updateGlobalVarsDisplay();
}

// Updated createNewDevices function to work with three-column VAV selection
function createNewDevices() {
    if (!globalVariablesConfig.selectedDriverPath) {
        showDeviceMessage('Please select a driver path first', 'error');
        return;
    }
    const deviceName = newDeviceName.value.trim();
    const count = parseInt(deviceCount.value) || 1;
    if (!deviceName) {
        showDeviceMessage('Please enter a device name', 'error');
        return;
    }
    if (count < 1 || count > 120) {
        showDeviceMessage('Device count must be between 1 and 120', 'error');
        return;
    }
    const deviceNames = generateDeviceNames(deviceName, count);
    const existingDevices = [];
    const newDevices = [];
    deviceNames.forEach(name => {
        if (globalVariablesConfig.globalVariables[name]) {
            existingDevices.push(name);
        } else {
            newDevices.push(name);
        }
    });
    if (existingDevices.length > 0) {
        showDeviceMessage(`Some devices already exist: ${existingDevices.join(', ')}. Only new devices will be created.`, 'warning');
    }
    if (newDevices.length === 0) {
        showDeviceMessage('All specified devices already exist', 'error');
        return;
    }
    newDevices.forEach(name => {
        globalVariablesConfig.globalVariables[name] = {
            basePath: globalVariablesConfig.selectedDriverPath.replace('{headerName}', name),
            driverPath: globalVariablesConfig.selectedDriverPath,
            points: [],
            dateCreated: new Date().toISOString(),
            Type: "N/A" // default - will be updated by VAV selection if applicable
        };
    });
    selectedDevices = newDevices;
    updateBulkPointIndicator();
    
    // Check for VAVs and show three-column selection modal
    const vavs = newDevices.filter(d => d.toUpperCase().includes("VAV"));
    if (vavs.length > 0) {
        handleVavSelection(newDevices); // Pass all new devices to the handler
        return; // Stop here until user confirms VAV selection
    }
    
    // If no VAVs, continue normal flow
    finalizeDeviceCreation(newDevices);
}

function finalizeDeviceCreation(newDevices) {
    updateMetadata();
    saveToLocalStorage();
    updateDeviceSelector();
    updateGlobalVarsDisplay();
    newDeviceName.value = '';
    deviceCount.value = '1';
    deviceCreationPreview.classList.add('hidden');
    
    if (newDevices.length === 1) {
        currentDevice = newDevices[0];
        deviceSelector.value = currentDevice;
        showDeviceMessage(`Device "${newDevices[0]}" created successfully!`, 'success');
    } else {
        showDeviceMessage(`${newDevices.length} devices created successfully: ${newDevices.join(', ')}`, 'success');
    }
}


        
        
        
        
        
        
        
        
// Add this code to your existing script

// Create the finished button (add this where your other buttons are defined)
const finishedBtn = document.createElement('button');
finishedBtn.id = 'finishedBtn';
finishedBtn.className = 'config-btn';
finishedBtn.textContent = 'Finished';
finishedBtn.style.marginLeft = '10px';

// Add the button after the save point button
savePointBtn.parentNode.insertBefore(finishedBtn, savePointBtn.nextSibling);

// Create the alarm selection modal
const alarmModal = document.createElement("div");
alarmModal.className = "config-modal hidden";
alarmModal.innerHTML = `
  <div class="config-form" style="max-width: 600px;">
    <h2>Select Points for Alarm Configuration</h2>
    <p style="color: #666; margin-bottom: 15px;">Select point types that should have alarm monitoring enabled across all devices:</p>
    <div style="margin-bottom: 15px;">
      <button id="selectAllPointsBtn" class="config-btn" style="margin-right: 10px;">Select All</button>
      <button id="deselectAllPointsBtn" class="config-btn">Deselect All</button>
    </div>
    <div id="pointsList" style="margin-bottom: 20px; max-height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 15px; background: #f9f9f9;"></div>
    <div style="text-align: right;">
      <button id="cancelAlarmBtn" class="config-btn" style="margin-right: 10px;">Cancel</button>
      <button id="confirmAlarmBtn" class="config-btn success">Apply Alarm Settings</button>
    </div>
  </div>
`;
document.body.appendChild(alarmModal);

// Get modal elements
const pointsList = alarmModal.querySelector("#pointsList");
const confirmAlarmBtn = alarmModal.querySelector("#confirmAlarmBtn");
const cancelAlarmBtn = alarmModal.querySelector("#cancelAlarmBtn");
const selectAllPointsBtn = alarmModal.querySelector("#selectAllPointsBtn");
const deselectAllPointsBtn = alarmModal.querySelector("#deselectAllPointsBtn");

let alarmMouseUpHandler = null;
let isAlarmDragging = false;
let alarmInitialCheckState = false;

// Finished button click handler
finishedBtn.addEventListener('click', function(e) {
    // Prevent any default behavior and event bubbling
    e.preventDefault();
    e.stopPropagation();
    
    console.log('Finished button clicked - starting alarm modal');
    
    try {
        // Collect unique point names and count devices for each
        const pointMap = new Map(); // pointName -> { devices: [deviceNames], sampleId: string }
        const devices = Object.keys(globalVariablesConfig.globalVariables);
        
        console.log('Found devices:', devices);
        
        devices.forEach(deviceName => {
            const deviceConfig = globalVariablesConfig.globalVariables[deviceName];
            if (deviceConfig && deviceConfig.points) {
                deviceConfig.points.forEach(point => {
                    const pointName = point.name;
                    
                    if (!pointMap.has(pointName)) {
                        pointMap.set(pointName, {
                            devices: [],
                            sampleId: point.id || 'N/A'
                        });
                    }
                    
                    pointMap.get(pointName).devices.push(deviceName);
                });
            }
        });
        
        console.log('Found unique points:', pointMap);
        
        if (pointMap.size === 0) {
            showPointMessage('No points found. Please create some devices and add points first.', 'error');
            return;
        }
        
        // Convert map to array and sort by point name for consistent display
        const uniquePoints = Array.from(pointMap.entries())
            .map(([pointName, data]) => ({
                pointName,
                deviceCount: data.devices.length,
                devices: data.devices,
                sampleId: data.sampleId
            }))
            .sort((a, b) => a.pointName.localeCompare(b.pointName));
        
        // Populate the points list with checkboxes for unique points only
        pointsList.innerHTML = uniquePoints.map((point, index) => {
            const checkboxId = `alarm_chk_${index}`;
            return `
                <div class="checkbox-group alarm-point-item" style="margin-bottom: 10px; padding: 8px; border-radius: 4px; cursor: pointer; user-select: none; border: 1px solid #e0e0e0; background: white;" 
                     data-point-name="${point.pointName}" data-index="${index}">
                    <input type="checkbox" id="${checkboxId}" style="margin-right: 10px;">
                    <label for="${checkboxId}" style="cursor: pointer; user-select: none; pointer-events: none; font-weight: 500;">
                        <strong>${point.pointName}</strong>
                        <span style="color: #666; font-size: 0.9em;">
                            (${point.sampleId}) - Found in ${point.deviceCount} device${point.deviceCount !== 1 ? 's' : ''}
                        </span>
                    </label>
                </div>
            `;
        }).join('');
        
        // Store the unique points data for later use
        pointsList.uniquePointsData = uniquePoints;
        
        // Remove any existing mouse up handler
        if (alarmMouseUpHandler) {
            document.removeEventListener('mouseup', alarmMouseUpHandler);
        }
        
        // Add drag-to-select functionality for alarm modal
        const alarmCheckboxGroups = pointsList.querySelectorAll('.alarm-point-item');
        
        alarmCheckboxGroups.forEach(group => {
            // Mouse down - start drag selection
            group.addEventListener('mousedown', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                isAlarmDragging = true;
                const checkbox = this.querySelector('input[type="checkbox"]');
                
                // Toggle the checkbox and remember the new state for consistent dragging
                checkbox.checked = !checkbox.checked;
                alarmInitialCheckState = checkbox.checked;
                
                // Add visual feedback
                this.style.backgroundColor = '#e8f5e8';
            });
            
            // Mouse enter during drag - select items as we drag over them
            group.addEventListener('mouseenter', function(e) {
                if (isAlarmDragging) {
                    const checkbox = this.querySelector('input[type="checkbox"]');
                    checkbox.checked = alarmInitialCheckState;
                    this.style.backgroundColor = '#e8f5e8';
                } else {
                    // Normal hover effect when not dragging
                    this.style.backgroundColor = '#f0f8ff';
                }
            });
            
            // Mouse leave - reset hover effect
            group.addEventListener('mouseleave', function(e) {
                if (!isAlarmDragging) {
                    this.style.backgroundColor = 'white';
                }
            });
            
            // Click handler for individual selection (only when not dragging)
            group.addEventListener('click', function(e) {
                if (!isAlarmDragging) {
                    e.preventDefault();
                    const checkbox = this.querySelector('input[type="checkbox"]');
                    checkbox.checked = !checkbox.checked;
                }
            });
        });
        
        // Create and add global mouse up handler for alarm modal
        alarmMouseUpHandler = function(e) {
            if (isAlarmDragging) {
                isAlarmDragging = false;
                
                // Reset all background colors
                alarmCheckboxGroups.forEach(group => {
                    group.style.backgroundColor = 'white';
                });
            }
        };
        
        document.addEventListener('mouseup', alarmMouseUpHandler);
        
        // Prevent text selection during drag
        pointsList.addEventListener('selectstart', function(e) {
            if (isAlarmDragging) {
                e.preventDefault();
            }
        });
        
        // Show the modal
        alarmModal.classList.remove("hidden");
        
    } catch (error) {
        console.error('Error in finished button handler:', error);
        showPointMessage('Error loading points: ' + error.message, 'error');
        return;
    }
});

// Select All Points button handler
selectAllPointsBtn.addEventListener("click", () => {
    const checkboxes = pointsList.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
        checkbox.checked = true;
    });
});

// Deselect All Points button handler
deselectAllPointsBtn.addEventListener("click", () => {
    const checkboxes = pointsList.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
});

// Cancel button handler
cancelAlarmBtn.addEventListener("click", () => {
    alarmModal.classList.add("hidden");
});

// Confirm alarm settings button handler
confirmAlarmBtn.addEventListener("click", () => {
    const checkboxes = pointsList.querySelectorAll('input[type="checkbox"]');
    const uniquePointsData = pointsList.uniquePointsData;
    let totalUpdatedCount = 0;
    let selectedPointTypes = 0;
    let unselectedPointTypes = 0;
    
    checkboxes.forEach((checkbox, index) => {
        const pointData = uniquePointsData[index];
        const pointName = pointData.pointName;
        const affectedDevices = pointData.devices;
        
        if (checkbox.checked) {
            // Set "Alarm": "yes" for this point type in all devices that have it
            selectedPointTypes++;
            affectedDevices.forEach(deviceName => {
                const deviceConfig = globalVariablesConfig.globalVariables[deviceName];
                const point = deviceConfig.points.find(p => p.name === pointName);
                if (point) {
                    point.Alarm = "yes";
                    totalUpdatedCount++;
                }
            });
        } else {
            // Set "Alarm": "no" for this point type in all devices that have it
            unselectedPointTypes++;
            affectedDevices.forEach(deviceName => {
                const deviceConfig = globalVariablesConfig.globalVariables[deviceName];
                const point = deviceConfig.points.find(p => p.name === pointName);
                if (point) {
                    point.Alarm = "no";
                    totalUpdatedCount++;
                }
            });
        }
    });
    
    // Update metadata and save
    updateMetadata();
    saveToLocalStorage();
    updateGlobalVarsDisplay();
    
    // Show success message
    showPointMessage(
        `Alarm settings applied to ${totalUpdatedCount} total points across all devices. ${selectedPointTypes} point type(s) enabled, ${unselectedPointTypes} point type(s) disabled.`,
        'success'
    );
    
    // Hide the modal
    alarmModal.classList.add("hidden");
});

// Debug logging to help identify issues
console.log('Finished button alarm modal code loaded successfully (unique points version)');

    </script>


</body>
</html>