<!DOCTYPE html>
<!-- @noSnoop -->
<html lang="en" xmlns:b="http://www.tridium.com/baja/baja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Murphy Control Panel - Chiller Monitoring</title>
    
    <!-- Add RequireJS and BajaScript Support -->
    <script type='text/javascript' src='/requirejs/config.js'></script>
    <script type='text/javascript' src='/module/js/com/tridium/js/ext/require/require.min.js?'></script>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #0d1421 0%, #1a1f3a 50%, #0f2027 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: linear-gradient(145deg, rgba(13, 20, 33, 0.95), rgba(26, 31, 58, 0.9));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(64, 224, 208, 0.2);
            border-radius: 16px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.4),
                0 0 20px rgba(64, 224, 208, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3a8a, #312e81, #1e40af);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent, rgba(64, 224, 208, 0.1), transparent);
            animation: shimmer 4s ease-in-out infinite;
        }

        @keyframes shimmer {
            0%, 100% { transform: translateX(-100%); }
            50% { transform: translateX(100%); }
        }

        .header h1 {
            margin: 0;
            font-size: 28px;
            position: relative;
            z-index: 1;
            text-shadow: 0 0 15px rgba(64, 224, 208, 0.3);
        }

        .main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            padding: 20px;
        }

        .tables-container {
            background: linear-gradient(145deg, rgba(13, 20, 33, 0.95), rgba(26, 31, 58, 0.9));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(64, 224, 208, 0.2);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        }

        .chiller-section {
            flex: 1;
            min-width: 300px;
        }

        .section-title {
            font-size: 20px;
            font-weight: bold;
            color: #40e0d0;
            text-shadow: 0 0 10px rgba(64, 224, 208, 0.5);
            margin-bottom: 15px;
            padding: 12px;
            background: linear-gradient(135deg, rgba(30, 58, 138, 0.4), rgba(49, 46, 129, 0.3));
            border-radius: 8px;
            border: 1px solid rgba(64, 224, 208, 0.3);
            text-align: center;
        }

        .chiller-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            background: transparent;
        }

        .chiller-table th {
            background: linear-gradient(135deg, #1e3a8a, #312e81, #1e40af);
            color: #e0f7fa;
            padding: 10px 6px;
            text-align: center;
            font-weight: bold;
            border-right: 1px solid rgba(64, 224, 208, 0.3);
            text-shadow: 0 0 8px rgba(64, 224, 208, 0.4);
            position: relative;
            font-size: 11px;
        }

        .chiller-table th::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent, rgba(64, 224, 208, 0.05), transparent);
            pointer-events: none;
        }

        .chiller-table th:last-child {
            border-right: none;
        }

        .chiller-table td {
            padding: 8px 6px;
            text-align: center;
            border-bottom: 1px solid rgba(64, 224, 208, 0.15);
            border-right: 1px solid rgba(64, 224, 208, 0.15);
            background: rgba(13, 20, 33, 0.6);
            color: #b0bec5;
            transition: all 0.3s ease;
            font-size: 11px;
        }

        .chiller-table td:last-child {
            border-right: none;
        }

        .chiller-table tr:hover td {
            background: linear-gradient(90deg, rgba(30, 58, 138, 0.3), rgba(49, 46, 129, 0.3));
            transform: scale(1.01);
            box-shadow: 0 4px 15px rgba(64, 224, 208, 0.2);
        }

        .point-label {
            font-weight: bold;
            color: #40e0d0;
            text-shadow: 0 0 10px rgba(64, 224, 208, 0.5);
            text-align: left;
            padding-left: 10px;
            font-size: 11px;
        }

        .value-loading {
            color: #7c3aed;
            font-style: italic;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

        .value-error {
            color: #f87171;
            font-style: italic;
            text-shadow: 0 0 5px rgba(248, 113, 113, 0.5);
        }

        .value-normal {
            color: #67e8f9;
            font-weight: 500;
            text-shadow: 0 0 8px rgba(103, 232, 249, 0.3);
        }

        .value-active {
            color: #34d399;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(52, 211, 153, 0.5);
            animation: glow-green 2s ease-in-out infinite alternate;
        }

        @keyframes glow-green {
            from { text-shadow: 0 0 10px rgba(52, 211, 153, 0.5); }
            to { text-shadow: 0 0 15px rgba(52, 211, 153, 0.7); }
        }

        .value-inactive {
            color: #64748b;
            text-shadow: 0 0 5px rgba(100, 116, 139, 0.3);
        }

        .value-alarm {
            color: #ef4444;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(239, 68, 68, 0.7);
            animation: glow-red 1.5s ease-in-out infinite alternate;
        }

        @keyframes glow-red {
            from { text-shadow: 0 0 10px rgba(239, 68, 68, 0.7); }
            to { text-shadow: 0 0 15px rgba(239, 68, 68, 0.9); }
        }

        .error {
            background: linear-gradient(135deg, rgba(30, 58, 138, 0.3), rgba(49, 46, 129, 0.2));
            color: #f87171;
            padding: 20px;
            text-align: center;
            border-radius: 8px;
            margin: 20px;
            border: 1px solid rgba(248, 113, 113, 0.3);
            backdrop-filter: blur(5px);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #40e0d0;
            font-size: 16px;
            text-shadow: 0 0 10px rgba(64, 224, 208, 0.5);
        }

        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Chiller System Monitoring</h1>
        </div>
        <div id="main-content">
            <div class="loading">Loading Chiller data...</div>
        </div>
    </div>

<script>
    // Global variables
    let pointSubscriptions = [];
    let pointValues = {};
    let allChillerPoints = {};
    let subscriber;

    // User authorization check
    function isAuthorizedUser() {
        const username = 'murphy'; // Simulated user
        console.log('Current user:', username);
        
        if (!username) {
            console.log('No user found');
            return false;
        }
        
        const authorizedUsers = ['murphy', 'admin'];
        const isAuthorized = authorizedUsers.includes(username.toLowerCase());
        
        console.log('User authorized for point display:', isAuthorized);
        return isAuthorized;
    }

    // Check authorization before proceeding
    if (!isAuthorizedUser()) {
        console.log('Point display script terminated - user not authorized');
        document.getElementById('main-content').innerHTML = 
            '<div class="error">Access Denied: You do not have permission to view point data.</div>';
        throw new Error('Unauthorized access');
    }

    // Chiller point definitions
    const chillerPoints = [
        { id: 'CH-ALM', label: 'Chiller Alarm' },
        { id: 'CH-EN', label: 'Chilled Enable' },
        { id: 'CH-WTR-ENT', label: 'Chilled Water Enter' },
        { id: 'CH-WTR-LEAVE', label: 'Chilled Water Leaving' },
        { id: 'CH-CONDTMP-ENTER', label: 'Cond TMP Enter' },
        { id: 'CH-CONDTMP-LEAVE', label: 'Cond TMP Leave' },
        { id: 'CH-CondPMP', label: 'Condenser Stat' },
        { id: 'CH-Compressor-Stat', label: 'Compressor Status' }
    ];

    const chillerPlantPoints = [
        { id: 'TWR-ENT-WTR', label: 'Tower Enter Temp' },
        { id: 'CH1-EN', label: 'Chiller 1 Enable' },
        { id: 'CH2-EN', label: 'Chiller 2 Enable' },
        { id: 'CH3-EN', label: 'Chiller 3 Enable' },
        { id: 'CH1-Stat', label: 'Chiller 1 Status' },
        { id: 'CH2-Stat', label: 'Chiller 2 Status' },
        { id: 'CH3-Stat', label: 'Chiller 3 Status' },
        { id: 'CH1-ALM', label: 'Chiller 1 Alarm' },
        { id: 'CH2-ALM', label: 'Chiller 2 Alarm' },
        { id: 'CH3-ALM', label: 'Chiller 3 Alarm' },
        { id: 'CH-LEAD', label: 'Lead Chiller' }
    ];

    // Function to format point values
    function formatPointValue(value, pointId) {
        if (value === null || value === undefined || value === 'N/A' || value === 'Connection Error') {
            return value === 'Connection Error' ? 'Connection Error' : 'N/A';
        }
        
        // Check if value is a boolean
        if (typeof value === 'boolean') {
            // Boolean-specific points
            if (pointId === 'CH-EN' || pointId.includes('-EN')) {
                return value ? 'Enabled' : 'Disabled';
            }
            if (pointId === 'CH-ST' || pointId.includes('-Stat') || pointId === 'CH-Compressor-Stat') {
                return value ? 'Running' : 'Stopped';
            }
            if (pointId === 'CH-ALM' || pointId.includes('-ALM')) {
                return value ? 'ALARM' : 'Normal';
            }
            if (pointId === 'CH-LEAD') {
                return value ? 'Lead' : 'Lag';
            }
            // Generic boolean
            return value ? 'ON' : 'OFF';
        }
        
        // Temperature/Water points (numeric values)
        if (pointId.includes('WTR') || pointId.includes('TMP') || pointId.includes('CONDTMP') || 
            pointId.includes('TWR') || pointId.includes('Cond')) {
            if (typeof value === 'number') {
                return value.toFixed(1) + '¬∞F';
            }
        }
        
        // Numeric values
        if (typeof value === 'number') {
            return value.toFixed(1);
        }
        
        // String values
        return value.toString();
    }

    // Function to get CSS class for value styling
    function getValueClass(value, pointId) {
        if (value === null || value === undefined || value === 'N/A' || value === 'Connection Error') {
            return 'value-error';
        }
        
        // Alarm points - highlight if active
        if (pointId === 'CH-ALM' || pointId.includes('-ALM')) {
            return (typeof value === 'boolean' && value) ? 'value-alarm' : 'value-normal';
        }
        
        // Status/Enable points - check boolean values
        if (pointId === 'CH-EN' || pointId === 'CH-ST' || pointId === 'CH-Compressor-Stat' ||
            pointId.includes('-EN') || pointId.includes('-Stat')) {
            if (typeof value === 'boolean') {
                return value ? 'value-active' : 'value-inactive';
            }
        }
        
        // Lead chiller
        if (pointId === 'CH-LEAD') {
            if (typeof value === 'boolean') {
                return value ? 'value-active' : 'value-inactive';
            }
        }
        
        // Temperature values - always normal styling
        if (typeof value === 'number') {
            return 'value-normal';
        }
        
        return 'value-normal';
    }

    // Function to update point value in the display
    function updatePointValue(chillerName, pointId, value) {
        const elementId = `point-${chillerName}-${pointId}`;
        const valueElement = document.getElementById(elementId);
        if (valueElement) {
            const formattedValue = formatPointValue(value, pointId);
            const valueClass = getValueClass(value, pointId);
            
            valueElement.textContent = formattedValue;
            valueElement.className = valueClass;
            
            if (!pointValues[chillerName]) pointValues[chillerName] = {};
            pointValues[chillerName][pointId] = value;
        }
    }

    // Initialize subscriber
    try {
        require(['baja!'], function(baja) {
            subscriber = new baja.Subscriber();
            
            subscriber.attach('changed', function(prop) {
                if (prop.getName() === 'out') {
                    const pointInfo = this.userData;
                    if (pointInfo) {
                        const out = this.getOut();
                        const displayValue = out.getValue();
                        
                        updatePointValue(pointInfo.chillerName, pointInfo.pointId, displayValue);
                    }
                }
            });
        });
    } catch (error) {
        console.error('Failed to initialize subscriber:', error);
    }

    // Function to subscribe to a point using Niagara Baja
    function subscribeToPoint(chillerName, pointId, pointPath) {
        console.log(`Subscribing to: ${pointPath}`);
        
        try {
            require(['baja!'], function(baja) {
                baja.Ord.make(pointPath).get({ subscriber: subscriber })
                    .then(point => {
                        console.log(`‚úÖ Successfully connected to ${pointId}: ${pointPath}`);
                        
                        point.userData = { 
                            chillerName: chillerName,
                            pointId: pointId, 
                            pointPath: pointPath
                        };
                        
                        const out = point.getOut();
                        const displayValue = out.getValue();
                        
                        updatePointValue(chillerName, pointId, displayValue);
                    })
                    .catch(error => {
                        console.error(`‚ùå Failed to connect to ${pointId} (${pointPath}):`, error);
                        updatePointValue(chillerName, pointId, 'Connection Error');
                    });
            });
        } catch (error) {
            console.error(`Failed to subscribe to ${pointPath}:`, error);
            updatePointValue(chillerName, pointId, 'Connection Error');
        }
    }

    // Function to create horizontal chiller tables
    function createHorizontalChillerTable(chillerNames, points, isPlant = false) {
        let html = `
            <div class="chiller-section">
                <table class="chiller-table">
                    <thead>
                        <tr>
                            <th>Point</th>
        `;
        
        // Add header for each chiller
        chillerNames.forEach(name => {
            html += `<th>${name}</th>`;
        });
        
        html += `
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        // Add row for each point
        points.forEach(point => {
            html += `<tr><td class="point-label">${point.label}</td>`;
            
            chillerNames.forEach(chillerName => {
                html += `<td id="point-${chillerName}-${point.id}" class="value-loading">Loading...</td>`;
            });
            
            html += `</tr>`;
        });
        
        html += `
                    </tbody>
                </table>
            </div>
        `;
        
        return html;
    }

    // Function to create the complete chiller display
    function createChillerDisplay(chillerData) {
        const mainContent = document.getElementById('main-content');
        
        if (Object.keys(chillerData).length === 0) {
            mainContent.innerHTML = '<div class="error">No Chiller configurations found in JSON file.</div>';
            return;
        }
        
        let html = '<div class="main-grid">';
        
        // Get available chillers
        const availableChillers = ['Chiller_1', 'Chiller_2', 'Chiller_3'].filter(name => chillerData[name]);
        
        // Create horizontal table for Chiller_1, Chiller_2, Chiller_3
        if (availableChillers.length > 0) {
            html += '<div class="tables-container">';
            html += '<div class="section-title">Chillers</div>';
            html += createHorizontalChillerTable(availableChillers, chillerPoints);
            html += '</div>';
        }
        
        // Create table for Chiller_Plant (horizontal format)
        if (chillerData['Chiller_Plant']) {
            html += '<div class="tables-container">';
            html += '<div class="section-title">Chiller Plant</div>';
            html += createHorizontalChillerTable(['Chiller_Plant'], chillerPlantPoints, true);
            html += '</div>';
        }
        
        html += '</div>';
        mainContent.innerHTML = html;
        
        // Subscribe to all points
        Object.keys(chillerData).forEach(chillerName => {
            const points = chillerData[chillerName];
            const pointList = chillerName === 'Chiller_Plant' ? chillerPlantPoints : chillerPoints;
            
            pointList.forEach(pointDef => {
                const point = points.find(p => p.id === pointDef.id);
                if (point && point.status === 'connected') {
                    subscribeToPoint(chillerName, pointDef.id, point.fullPath);
                } else {
                    console.warn(`Point ${pointDef.id} not found or not connected for ${chillerName}`);
                    updatePointValue(chillerName, pointDef.id, 'N/A');
                }
            });
        });
    }

    // Function to load and parse JSON configuration
    async function loadAndDisplayChillerPoints() {
        try {
            console.log('=== LOADING CHILLER POINTS FROM JSON ===');
            
            const response = await fetch('../Global.json');
            
            if (!response.ok) {
                throw new Error(`Failed to load JSON: ${response.status} ${response.statusText}`);
            }
            
            const jsonData = await response.json();
            console.log('JSON data loaded:', jsonData);
            
            // Filter for Chiller configurations only
            const chillerConfigs = {};
            
            Object.keys(jsonData.globalVariables).forEach(key => {
                if (key === 'Chiller_1' || key === 'Chiller_2' || key === 'Chiller_3' || key === 'Chiller_Plant') {
                    console.log(`Found Chiller configuration: ${key}`);
                    const connectedPoints = jsonData.globalVariables[key].points.filter(point => 
                        point.status === "connected"
                    );
                    if (connectedPoints.length > 0) {
                        chillerConfigs[key] = connectedPoints;
                    }
                }
            });
            
            allChillerPoints = chillerConfigs;
            
            console.log('Filtered Chiller configurations:', chillerConfigs);
            console.log('=== CHILLER POINT LOADING COMPLETE ===');
            
            createChillerDisplay(chillerConfigs);
            
        } catch (error) {
            console.error('Error loading Chiller points from JSON:', error);
            document.getElementById('main-content').innerHTML = 
                `<div class="error">Error loading Chiller data: ${error.message}</div>`;
        }
    }

    // Cleanup function for subscriptions
    function cleanup() {
        if (subscriber) {
            subscriber.unsubscribeAll();
            console.log('üßπ Cleaned up all subscriptions');
        }
    }

    // Handle page unload
    window.addEventListener('beforeunload', cleanup);

    // Initialize the system
    loadAndDisplayChillerPoints();
</script>

</body>
</html>