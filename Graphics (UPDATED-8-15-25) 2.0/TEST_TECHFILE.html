<!DOCTYPE html>
<!-- @noSnoop -->
<html lang="en" xmlns:b="http://www.tridium.com/baja/baja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Murphy Control Panel - AHU Monitoring</title>

<!-- Add RequireJS and BajaScript Support -->
<script type='text/javascript' src='/requirejs/config.js'></script>
<script type='text/javascript' src='/module/js/com/tridium/js/ext/require/require.min.js?'></script>

<style>
* {
margin: 0;
padding: 0;
box-sizing: border-box;
}
body {
font-family: Arial, sans-serif;
background-color: #2a2a2a;
color: white;
height: 100vh;
display: flex;
flex-direction: column;
overflow: auto;
}

/* Configuration Modal Styles */
.config-modal {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background-color: rgba(0, 0, 0, 0.8);
display: flex;
justify-content: center;
align-items: center;
z-index: 10000;
}

.config-modal.hidden {
display: none;
}

.config-form {
background-color: #1a1a1a;
border: 2px solid #444;
border-radius: 10px;
padding: 30px;
width: 90%;
max-width: 500px;
box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
}

.config-form h2 {
color: #fff;
margin-bottom: 20px;
text-align: center;
font-size: 24px;
}

.form-group {
margin-bottom: 20px;
}

.form-group label {
display: block;
color: #ccc;
font-size: 14px;
margin-bottom: 8px;
font-weight: bold;
}

.form-group input {
width: 100%;
padding: 12px;
background-color: #333;
border: 1px solid #555;
border-radius: 5px;
color: white;
font-size: 14px;
}

.form-group input:focus {
outline: none;
border-color: #4CAF50;
background-color: #404040;
}

.form-group .help-text {
font-size: 12px;
color: #888;
margin-top: 5px;
font-style: italic;
}

.form-buttons {
display: flex;
gap: 15px;
justify-content: center;
margin-top: 25px;
}

.config-btn {
padding: 12px 24px;
border: none;
border-radius: 5px;
font-size: 16px;
font-weight: bold;
cursor: pointer;
transition: all 0.3s ease;
}

.config-btn.primary {
background-color: #4CAF50;
color: white;
}

.config-btn.primary:hover {
background-color: #45a049;
}

.config-btn.secondary {
background-color: #666;
color: white;
}

.config-btn.secondary:hover {
background-color: #777;
}

.top-bar {
background-color: #1a1a1a;
padding: 5px;
display: flex;
align-items: center;
border: 2px solid #444;
position: relative;
justify-content: space-between;
}        

.weather-cam {
background-color: #666;
width: 120px;
height: 60px;
border: 2px solid #888;
display: flex;
align-items: center;
justify-content: center;
font-size: 12px;
}

.admin-greeting {
background-color: #000;
width: 120px;
height: 60px;
border: 2px solid #888;
padding: 10px 15px;
display: flex;
align-items: center;
gap: 8px;
}

.admin-icon {
width: 20px;
height: 20px;
background-color: #fff;
border-radius: 50%;
}

.weather-info {
background-color: #333;
border: 2px solid #888;
padding: 8px 12px;
font-size: 12px;
}

.weather-info div {
margin-bottom: 2px;
}

.nav-icons {
display: flex;
gap: 10px;
}

.nav-icon {
width: 40px;
height: 40px;
background-color: #555;
border: 2px solid #888;
display: flex;
align-items: center;
justify-content: center;
cursor: pointer;
position: relative;
}

.nav-icon:hover {
background-color: #666;
}

.nav-icon::before {
content: '';
width: 20px;
height: 20px;
background-color: #fff;
}

.home-icon::before {
clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
}

.grid-icon::before {
background-image: 
linear-gradient(to right, #fff 0%, #fff 30%, transparent 30%, transparent 70%, #fff 70%, #fff 100%),
linear-gradient(to bottom, #fff 0%, #fff 30%, transparent 30%, transparent 70%, #fff 70%, #fff 100%);
}

.user-icon::before {
border-radius: 50%;
background-color: #fff;
}

.chart-icon::before {
background-image: linear-gradient(45deg, transparent 40%, #fff 40%, #fff 60%, transparent 60%);
}

.calendar-icon::before {
background-color: #fff;
border-radius: 2px;
}

.main-content {
flex: 1;
background: linear-gradient(to right,#010f35, #175f80,#266c79, #12707d);
position: relative;
display: flex;
justify-content: center;
align-items: center;
padding: 20px;
}

.controls-by {
position: absolute;
bottom: 50px;
right: 40px;
text-align: right;
font-size: 40px;
color: #ccc;
}

.murphy-logo-main {
font-size: 40px;
font-weight: bold;
color: #000;
margin-top: 5px;
display: flex;
align-items: center;
gap: 8px;
}

.murphy-m-logo {
width: 40px;
height: 40px;
background-color: #4CAF50;
display: flex;
align-items: center;
justify-content: center;
color: white;
font-weight: bold;
font-size: 18px;
border: 2px solid #4CAF50;
}

.bottom-bar {
background-color: #1a1a1a;
padding: 15px;
display: flex;
justify-content: space-between;
align-items: center;
border: 2px solid #444;
/*position: relative;*/
}

.back-button {
background-color: #FFA500;
border: 2px solid #888;
padding: 10px 28px;
color: #000;
font-weight: bold;
cursor: pointer;
display: flex;
align-items: center;
gap: 5px;
font-size: 20px;
/*position: absolute;*/
}

.back-button:hover {
background-color: #FFB500;
}

.murphy-logo-bottom {
background-color: #fff;
color: #000;
padding: 10px 20px;
font-weight: bold;
font-size: 30px;
border: 2px solid #4CAF50;
display: flex;
align-items: center;
gap: 10px;
margin: center;
}

.murphy-m-logo-bottom {
width: 40px;
height: 40px;
background-color: #4CAF50;
display: flex;
align-items: center;
justify-content: center;
color: white;
font-weight: bold;
font-size: 20px;
border: 2px solid #4CAF50;
}

.date-time {
background-color: #f0f0f0;
color: #000;
padding: 10px 15px;
border: 2px solid #888;
text-align: center;
font-size: 20px;
/*position: relative;*/
}

.logout-btn {
position: absolute;
bottom: 20px;
left: 20px;
background-color: #333;
border: 2px solid #888;
color: white;
padding: 8px 15px;
cursor: pointer;
font-size: 18px;
}

.logout-btn:hover {
background-color: #444;
}

.TopBar {
display: flex;
flex-direction: row;
width: 100%;
max-width: 1200px;
height: 100%;
justify-content: right;
gap: 10px;
padding: 10px;
}

.nav-images {
display: flex;
justify-content: flex-start;
align-items: center;
gap: 5px;
margin-left: auto;
}

/* AHU Monitoring Styles - FIXED */
.ahu-container {
/*display: flex;*/
flex-direction: column;
width: 100%;
max-width: 1200px;
height: auto;
justify-content: center;
gap: 40px;
padding: 20px;
position: relative; /* ADD THIS LINE */
}
.ahu-title {
position: absolute;
top: 20px;
left: 50%;
transform: translateX(-50%);
color: #ffffff;
font-weight: bold;
font-size: 2.5rem;
margin: 0;
}

.ahu-image-section {
flex: 0 0 auto;
display: flex;
justify-content: center;
align-items: center;
min-height: 200px;
}

/* FIXED: Better layout for status section */
.ahu-status-section {
display: flex;
flex-direction: column;
width: 100%;
gap: 20px;
}

.ahu-status-section h2 {
position: absolute;
color: #b6b6b6;
font-size: 1.5rem;
margin: 0 20px 0px -950px;
text-align: center;
}

.override-buttons {
display: flex;
gap: 10px;
margin-top: 10px;
}

.override-controls {
margin-top: 10px;
}

.control-label {
color: #cbd5e0;
font-size: 14px;
font-weight: 500;
}

.control-dropdown {
background-color: #2d3748;
border: 1px solid #4a5568;
border-radius: 6px;
padding: 8px 12px;
color: #ffffff;
font-size: 14px;
min-width: 100px;
cursor: pointer;
overflow-y: auto;        /* allow scrolling */
}

.control-dropdown:hover {
background-color: #4a5568;
}

.control-dropdown:focus {
outline: none;
border-color: #63b3ed;
}

/* FIXED: Grid layout for bubbles */
.status-bubbles-grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
gap: 15px;
width: 100%;
}

.status-bubbles-gridSP {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
gap: 20px;
width: 100%%;
box-sizing: border-box;
}

.bubbleSP {
width: 100%;              /* Take up available grid/cell space */
max-width: 100%;
box-sizing: border-box;
background: #2d3748;
color: white;
border-radius: 30px;      /* Match your bubble shape */
padding: 15px 20px;       /* Match bubble padding */
font-family: Arial, sans-serif;
box-shadow: 0 10px 8px rgba(0,0,0,0.4);
cursor: pointer;
display: flex;
flex-direction: column;
justify-content: center;
border: 2px solid rgba(2, 245, 253, 0.904);
}

.bubbleSP1 {
width: 100%;              /* Take up available grid/cell space */
max-width: 100%;
box-sizing: border-box;
background: #2d3748;
border: 2px solid rgba(2, 245, 253, 0.904);
border-radius: 30px;
padding: 15px 20px;
backdrop-filter: blur(5px);
box-shadow: 0 10px 8px rgba(255, 0, 0, 0.2);
text-align: center;
min-height: 60px;
display: flex;
align-items: center;
justify-content: center;
transition: transform 0.2s ease, box-shadow 0.2s ease;
}

/* FIXED: Better bubble styling */
.bubble {
background-color: rgba(201, 25, 93, 0.1);
border: 2px solid rgba(2, 245, 253, 0.904);
border-radius: 30px;
padding: 15px 20px;
backdrop-filter: blur(5px);
box-shadow: 0 10px 8px rgba(255, 0, 0, 0.2);
text-align: center;
min-height: 60px;
display: flex;
align-items: center;
justify-content: center;
transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.bubblebox {
background: #2d3748;
color: white;
border-radius: 12px;
padding: 20px;
width: 400px;
font-family: Arial, sans-serif;
box-shadow: 0 4px 8px rgba(0,0,0,0.4);
}

.bubble:hover {
transform: translateY(-2px);
box-shadow: 0 12px 12px rgba(255, 0, 0, 0.3);
}

.bubble p {
color: #ffffff;
margin: 0;
font-size: 16px;
font-weight: 500;
}

.data-value {
font-weight: bold;
font-size: 18px;
}

.status-off {
color: #ff6b6b;
}

.status-on {
color: #51cf66;
}

.override-on {
color: #4a0575;
}

/* Override Control Panel Styles */
.override-bubble {
background: linear-gradient(145deg, #4a5568, #2d3748);
border: 2px solid #718096;
border-radius: 12px;
padding: 20px;
min-height: 200px;
display: flex;
flex-direction: column;
gap: 15px;
box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
position: relative;
}

.override-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 10px;
}

.override-title {
color: #ffffff;
font-size: 18px;
font-weight: bold;
margin: 0;
}

.override-status {
color: #48bb78;
font-size: 16px;
font-weight: 600;
}

.override-status.active {
color: #f56565;
}

.control-group {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 10px;
}

.override-buttons {
display: flex;
gap: 10px;
margin-top: 10px;
}

.override-btn {
flex: 1;
padding: 10px 16px;
border: none;
border-radius: 6px;
font-size: 14px;
font-weight: 600;
cursor: pointer;
transition: all 0.2s ease;
}

.override-btn.override {
background-color: #4a0575;
color: white;
}

.override-btn.override:hover {
background-color: #240637;
}

.override-btn.override.active {
background-color: #3d065f;
box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
}

.override-btn.release {
background-color: #827c7c;
color: white;
}

.override-btn.release:hover {
background-color: rgb(67, 66, 66);
}

.override-btn.release.active {
background-color: #3e3c3c;
box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
}

.override-btn:disabled {
opacity: 0.5;
cursor: not-allowed;
}

.status-override {
color: #b794f4 
font-weight: bold;
}

.status-override::after {
content: " (Overridden)";
font-style: italic;
font-size: 0.9em;
}

/* Toggle Switch Styles */
.toggle-container {
position: absolute;
top: 20px;
right: 20px;
z-index: 1000;
display: flex;
align-items: center;
gap: 10px;
}

.toggle-label {
color: rgba(255, 255, 255, 0.9);
font-size: 14px;
font-weight: 500;
transition: color 0.3s ease;
}

.light-mode .toggle-label {
color: rgba(0, 0, 0, 0.7);
}

.toggle-switch {
position: relative;
width: 60px;
height: 30px;
background: rgba(255, 255, 255, 0.2);
border-radius: 25px;
cursor: pointer;
transition: all 0.3s ease;
backdrop-filter: blur(10px);
border: 1px solid rgba(255, 255, 255, 0.3);
}

.toggle-switch:hover {
background: rgba(255, 255, 255, 0.3);
transform: scale(1.05);
}

.toggle-slider {
position: absolute;
top: 3px;
left: 3px;
width: 24px;
height: 24px;
background: white;
border-radius: 50%;
transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.toggle-switch.active .toggle-slider {
transform: translateX(30px);
background: #fbbf24;
}

.light-mode .toggle-switch {
background: rgba(0, 0, 0, 0.1);
border: 1px solid rgba(0, 0, 0, 0.2);
}

/* Light mode styles */
body.light-mode .main-content {
background: linear-gradient(to right,#b3b7be, #8d8f93, #767d86, #616b7b);
}

.hamburger-menu {
position: absolute;
left: 10px;
top: 50%;
transform: translateY(-50%);
width: 40px;
height: 40px;
background-color: #333;
border: 2px solid #888;
cursor: pointer;
display: flex;
flex-direction: column;
justify-content: center;
align-items: center;
gap: 4px;
z-index: 1001;
transition: all 0.3s ease;
}

.hamburger-menu:hover {
background-color: #444;
}

.hamburger-line {
width: 20px;
height: 2px;
background-color: white;
transition: all 0.3s ease;
}

.hamburger-menu.active .hamburger-line:nth-child(1) {
transform: rotate(45deg) translate(5px, 5px);
}

.hamburger-menu.active .hamburger-line:nth-child(2) {
opacity: 0;
}

.hamburger-menu.active .hamburger-line:nth-child(3) {
transform: rotate(-45deg) translate(7px, -6px);
}

/* Side Panel Styles */
.side-panel {
position: fixed;
top: 0;
left: -300px;
width: 300px;
height: 100vh;
background-color: #1a1a1a;
border-right: 2px solid #444;
transition: left 0.3s ease;
z-index: 1000;
padding: 80px 0 20px 0;
box-shadow: 2px 0 10px rgba(0, 0, 0, 0.5);
}

.side-panel.active {
left: 0;
}

.side-panel-header {
padding: 20px;
border-bottom: 1px solid #444;
margin-bottom: 20px;
}

.side-panel-header h2 {
color: #fff;
font-size: 18px;
margin-bottom: 5px;
}

.side-panel-header p {
color: #ccc;
font-size: 14px;
}

.ahu-dropdown {
padding: 0 20px;
}

.ahu-dropdown-header {
display: flex;
align-items: center;
justify-content: space-between;
padding: 15px;
background-color: #333;
border: 1px solid #555;
cursor: pointer;
transition: background-color 0.3s ease;
margin-bottom: 10px;
}

.ahu-dropdown-header:hover {
background-color: #404040;
}

.ahu-dropdown-header h3 {
color: #fff;
font-size: 16px;
}

.dropdown-arrow {
color: #ccc;
font-size: 14px;
transition: transform 0.3s ease;
}

.ahu-dropdown.active .dropdown-arrow {
transform: rotate(180deg);
}

.ahu-dropdown-content {
max-height: 0;
overflow: auto;
transition: max-height 0.3s ease;
background-color: #2a2a2a;
border: 1px solid #555;
border-top: none;
}

.ahu-dropdown.active .ahu-dropdown-content {
max-height: 200px;
}

.ahu-option {
padding: 12px 20px;
color: #ccc;
cursor: pointer;
transition: all 0.3s ease;
border-bottom: 1px solid #444;
}

.ahu-option:last-child {
border-bottom: none;
}

/* Configuration Reopen Button */
.config-reopen-btn {
position: absolute;
top: 20px;
right: 20px;
background: linear-gradient(145deg, #4a5568, #2d3748);
border: 2px solid #4CAF50;
color: white;
padding: 12px 20px;
border-radius: 8px;
cursor: pointer;
font-size: 35px;
font-weight: bold;
display: flex;
align-items: center;
gap: 8px;
transition: all 0.3s ease;
z-index: 100;
box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
}

.config-reopen-btn:hover {
background: linear-gradient(145deg, #5a6578, #3d4758);
transform: translateY(-2px);
box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
border-color: #5CBF60;
}

.config-reopen-btn:active {
transform: translateY(0);
box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

.config-icon {
font-size: 16px;
}
      .config-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .config-modal.hidden {
            display: none;
        }

        .config-form {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 90%;
        }

        .config-form h2 {
            color: #333;
            margin-bottom: 25px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .help-text {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }

        .form-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 25px;
        }

        .config-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .config-btn.primary {
            background: #667eea;
            color: white;
        }

        .config-btn.primary:hover {
            background: #5a67d8;
        }

        .config-btn.secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .config-btn.secondary:hover {
            background: #cbd5e0;
        }

        .main-content {
            position: relative;
            min-height: 80vh;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .config-reopen-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
            z-index: 10;
        }

        .config-reopen-btn:hover {
            background: #5a67d8;
        }

        .ahu-status-section {
            position: relative;
            width: 100%;
            height: 600px;
            margin-top: 60px;
        }

        .status-bubbles-grid {
            position: relative;
            width: 100%;
            height: 100%;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            padding: 20px;
            box-sizing: border-box;
        }

        .bubble {
            background: linear-gradient(145deg, #ffffff, #f0f4f8);
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            min-height: 100px;
        }

        .bubble:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
        }

        .bubble a {
            text-decoration: none;
            color: inherit;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .bubble p {
            margin: 0;
            font-weight: 600;
            color: #2d3748;
            font-size: 14px;
            line-height: 1.4;
        }

        .point-name {
            font-size: 12px;
            color: #718096;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-value {
            font-size: 18px;
            font-weight: 700;
            margin-top: 5px;
        }

        .data-value.status-on {
            color: #38a169;
        }

        .data-value.status-off {
            color: #e53e3e;
        }

        .data-value.override-active {
            color: #8b5cf6;
        }

        .loading {
            color: #718096;
            font-style: italic;
        }

        .error {
            color: #e53e3e;
        }

        .dashboard-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .dashboard-header h1 {
            color: #2d3748;
            margin: 0;
            font-size: 2.5em;
            font-weight: 700;
        }

        .dashboard-header .ahu-name {
            color: #667eea;
            font-size: 1.2em;
            margin-top: 10px;
        }
    </style>
</head>
<body>

<!-- Configuration Modal -->
<div id="configModal" class="config-modal">
  <div class="config-form">
    <h2>AHU Configuration</h2>
    <form id="configForm">
      <div class="form-group">
        <label for="basePath">Base Path Template:</label>
        <input type="text" id="basePath" name="basePath" 
               value="station:|slot:/Drivers/BcpBacnetNetwork/{headerName}/points/{pointName}" 
               placeholder="Enter your base path template">
        <div class="help-text">Use {headerName} for AHU name and {pointName} for data point placeholders</div>
      </div>
      
      <div class="form-group">
        <label for="headerName">AHU Name (Header Name):</label>
        <input type="text" id="headerName" name="headerName" 
               placeholder="Enter AHU name (e.g., AHU-01)" required>
        <div class="help-text">This will replace {headerName} in your path template</div>
      </div>
      
      <div class="form-buttons">
        <button type="button" id="saveConfig" class="config-btn primary">Start Monitoring</button>
        <button type="button" id="resetConfig" class="config-btn secondary">Reset Defaults</button>
      </div>
    </form>
  </div>
</div>
  
<!-- CONTENT BODY  -->
<div class="main-content">

<!-- Configuration Button (Top Right) -->
<button id="configButton" class="config-reopen-btn" title="Reconfigure AHU Settings">
  <span class="config-icon">⚙️</span>
  Config
</button>

<!-- Dashboard Header -->
<div class="dashboard-header">
    <h1>AHU Monitoring Dashboard</h1>
    <div id="ahuNameDisplay" class="ahu-name"></div>
</div>
  
<!-- Dynamic Status Bubbles Container -->
<div class="ahu-status-section">
    <div id="statusBubblesGrid" class="status-bubbles-grid">
        <!-- Bubbles will be dynamically generated here -->
    </div>
</div>   
  
</div>   

<!-- Configuration and AHU Data Monitoring Script -->
<script>
// Configuration management
let userBasePath = '';
let userHeaderName = '';

// DOM elements for configuration
const configModal = document.getElementById('configModal');
const configForm = document.getElementById('configForm');
const basePathInput = document.getElementById('basePath');
const headerNameInput = document.getElementById('headerName');
const saveConfigBtn = document.getElementById('saveConfig');
const resetConfigBtn = document.getElementById('resetConfig');
const configButton = document.getElementById('configButton');
const ahuNameDisplay = document.getElementById('ahuNameDisplay');
const statusBubblesGrid = document.getElementById('statusBubblesGrid');

// Data point configuration with display names
const dataPointsConfig = {
    AHUALARM: {
        pointName: 'AHUAlarm',
        displayName: 'AHU Alarm',
        specialHandling: 'alarm' // Special case: OFF is good (green), ON is bad (red)
    },
    DischargeStatic: {
        pointName: 'DischargeAirStatic',
        displayName: 'Discharge Static',
        unit: 'in. WC'
    },
    OutsideAir: {
        pointName: 'OutsideAirTempShare',
        displayName: 'Outside Air Temp',
        unit: '°F'
    },
    FanStat: {
        pointName: 'SF_S',
        displayName: 'Fan Status'
    },
    DischargeAirTMP: {
        pointName: 'DischargeAirTemp',
        displayName: 'Discharge Air Temp',
        unit: '°F'
    },
    OccupancyCMD: {
        pointName: 'OccupiedCmd',
        displayName: 'Occupancy Command'
    },
    Fan_CMD: {
        pointName: 'DischargeAirSPOutput',
        displayName: 'Fan Command',
        unit: '%'
    },
    Damper_CMD: {
        pointName: 'DischargeAirStaticSPOutput',
        displayName: 'Damper Position',
        unit: '%'
    },
    DASPMAX: {
        pointName: 'DischargeAirSPMax',
        displayName: 'DA SP Max',
        unit: '°F'
    },
    DischargeStaticSP: {
        pointName: 'DischargeStaticSP',
        displayName: 'Static SP',
        unit: 'in. WC'
    },
    DischargeAirTMPSP: {
        pointName: 'DischargeAirSP',
        displayName: 'DA Temp SP',
        unit: '°F'
    }
};

// Initialize configuration on page load
document.addEventListener('DOMContentLoaded', function() {
    // Load saved configuration if exists
    const savedBasePath = sessionStorage.getItem('userBasePath');
    const savedHeaderName = sessionStorage.getItem('userHeaderName');
    
    if (savedBasePath && savedHeaderName) {
        // Use saved configuration
        userBasePath = savedBasePath;
        userHeaderName = savedHeaderName;
        basePathInput.value = savedBasePath;
        headerNameInput.value = savedHeaderName;
        
        // Update AHU name display
        ahuNameDisplay.textContent = savedHeaderName;
        
        // Hide modal and start monitoring
        configModal.classList.add('hidden');
        createDynamicBubbles();
        startMonitoring();
    } else {
        // Show configuration modal
        configModal.classList.remove('hidden');
    }
});

// Configuration event handlers
saveConfigBtn.addEventListener('click', function() {
    const basePath = basePathInput.value.trim();
    const headerName = headerNameInput.value.trim();
    
    if (!basePath || !headerName) {
        alert('Please fill in both fields');
        return;
    }
    
    // Validate that basePath contains required placeholders
    if (!basePath.includes('{headerName}') || !basePath.includes('{pointName}')) {
        alert('Base path must contain {headerName} and {pointName} placeholders');
        return;
    }
    
    // Save configuration
    userBasePath = basePath;
    userHeaderName = headerName;
    sessionStorage.setItem('userBasePath', basePath);
    sessionStorage.setItem('userHeaderName', headerName);
    
    // Update AHU name display
    ahuNameDisplay.textContent = headerName;
    
    // Hide modal, create bubbles, and start monitoring
    configModal.classList.add('hidden');
    createDynamicBubbles();
    startMonitoring();
});

resetConfigBtn.addEventListener('click', function() {
    basePathInput.value = 'station:|slot:/Drivers/BcpBacnetNetwork/{headerName}/points/{pointName}';
    headerNameInput.value = '';
    sessionStorage.removeItem('userBasePath');
    sessionStorage.removeItem('userHeaderName');
});

// Configuration button event handler
configButton.addEventListener('click', function() {
    // Populate current values
    basePathInput.value = userBasePath || 'station:|slot:/Drivers/BcpBacnetNetwork/{headerName}/points/{pointName}';
    headerNameInput.value = userHeaderName || '';
    
    // Show modal
    configModal.classList.remove('hidden');
});

// Function to create dynamic bubbles based on dataPointsConfig
function createDynamicBubbles() {
    // Clear existing bubbles
    statusBubblesGrid.innerHTML = '';
    
    // Create a bubble for each data point
    Object.keys(dataPointsConfig).forEach(pointId => {
        const config = dataPointsConfig[pointId];
        
        // Create bubble element
        const bubble = document.createElement('div');
        bubble.className = 'bubble';
        
        // Create link wrapper (for consistency with original design)
        const link = document.createElement('a');
        link.href = '../Logs.html';
        
        // Create point name label
        const pointLabel = document.createElement('div');
        pointLabel.className = 'point-name';
        pointLabel.textContent = config.displayName;
        
        // Create value display
        const valueSpan = document.createElement('span');
        valueSpan.id = pointId;
        valueSpan.className = 'data-value loading';
        valueSpan.textContent = 'Loading...';
        
        // Create main text with unit if specified
        const mainText = document.createElement('p');
        if (config.unit) {
            mainText.innerHTML = `<span class="data-value" id="${pointId}">${valueSpan.outerHTML}</span> ${config.unit}`;
        } else {
            mainText.appendChild(valueSpan);
        }
        
        // Assemble the bubble
        link.appendChild(pointLabel);
        link.appendChild(mainText);
        bubble.appendChild(link);
        
        // Add bubble to grid
        statusBubblesGrid.appendChild(bubble);
    });
}

// Function to generate AHU path with user configuration
function ahuPath(pointName) {
    console.log('=== ahuPath() called ===');
    console.log('Input pointName:', pointName);
    console.log('User base path:', userBasePath);
    console.log('User header name:', userHeaderName);
    
    // Create the final path using user inputs
    const finalPath = userBasePath
        .replace('{headerName}', userHeaderName)
        .replace('{pointName}', pointName);
    
    console.log('Final generated path:', finalPath);
    console.log('========================');
    
    return finalPath;
}

// Start monitoring function
function startMonitoring() {
    require(['baja!'], function (baja) {
        'use strict';
        
        console.log('=== STARTING MONITORING ===');
        console.log('Using base path:', userBasePath);
        console.log('Using header name:', userHeaderName);

        // Generate dataPoints object from configuration
        const dataPoints = {};
        Object.keys(dataPointsConfig).forEach(pointId => {
            const config = dataPointsConfig[pointId];
            dataPoints[pointId] = ahuPath(config.pointName);
        });

        console.log('Generated data points:', dataPoints);

        // Create subscriber for data changes
        const subscriber = new baja.Subscriber();

        // Subscriber event handler
        subscriber.attach('changed', function(prop) {
            if (prop.getName() === 'out') {
                const pointInfo = this.userData;
                const pointElement = document.getElementById(pointInfo.elementId);
                
                if (pointInfo && pointElement) {
                    const out = this.getOut();
                    const displayValue = out.getValueDisplay();
                    const value = out.getValue();
                    const isOverridden = this.getStatus().isOverridden();
                    const config = dataPointsConfig[pointInfo.elementId];

                    // Update the element
                    if (isOverridden) {
                        // Point is overridden - show purple
                        pointElement.className = 'data-value override-active';
                        pointElement.textContent = `${displayValue} (Override)`;
                    } else if (config && config.specialHandling === 'alarm') {
                        // Special handling for alarm points - OFF is good (green), ON is bad (red)
                        if (value && (value.toString().toLowerCase().includes('on') || value > 0)) {
                            pointElement.className = 'data-value status-off'; // Alarm active = red
                            pointElement.textContent = displayValue;
                        } else {
                            pointElement.className = 'data-value status-on'; // No alarm = green
                            pointElement.textContent = displayValue;
                        }
                    } else if (value && (value.toString().toLowerCase().includes('on') || value > 0)) {
                        pointElement.className = 'data-value status-on';
                        pointElement.textContent = displayValue;
                    } else {
                        pointElement.className = 'data-value status-off';
                        pointElement.textContent = displayValue;
                    }
                }
            }
        });

        // Function to subscribe to a point
        function subscribeToPoint(pointOrd, elementId) {
            baja.Ord.make(pointOrd).get({ subscriber: subscriber })
                .then(point => {
                    console.log(`Successfully connected to ${elementId}`);

                    // Store reference for the subscriber callback
                    point.userData = { elementId: elementId };

                    // Initial update
                    const out = point.getOut();
                    const displayValue = out.getValueDisplay();
                    const value = out.getValue();
                    const isOverridden = point.getStatus().isOverridden();
                    const pointElement = document.getElementById(elementId);
                    const config = dataPointsConfig[elementId];

                    if (pointElement) {
                        if (isOverridden) {
                            // Point is overridden - show purple
                            pointElement.className = 'data-value override-active';
                            pointElement.textContent = `${displayValue} (Override)`;
                        } else if (config && config.specialHandling === 'alarm') {
                            // Special handling for alarm points - OFF is good (green), ON is bad (red)
                            if (value && (value.toString().toLowerCase().includes('on') || value > 0)) {
                                pointElement.className = 'data-value status-off'; // Alarm active = red
                                pointElement.textContent = displayValue;
                            } else {
                                pointElement.className = 'data-value status-on'; // No alarm = green
                                pointElement.textContent = displayValue;
                            }
                        } else if (value && (value.toString().toLowerCase().includes('on') || value > 0)) {
                            pointElement.className = 'data-value status-on';
                            pointElement.textContent = displayValue;
                        } else {
                            pointElement.className = 'data-value status-off';
                            pointElement.textContent = displayValue;
                        }
                    }
                })
                .catch(error => {
                    console.error(`Failed to connect to ${elementId}:`, error);
                    const pointElement = document.getElementById(elementId);
                    if (pointElement) {
                        pointElement.textContent = 'Error';
                        pointElement.className = 'data-value error';
                    }
                });
        }

        // Subscribe to all data points dynamically
        Object.keys(dataPoints).forEach(pointId => {
            subscribeToPoint(dataPoints[pointId], pointId);
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (subscriber) {
                subscriber.unsubscribeAll();
            }
        });

    });
}

// Allow reconfiguration by clicking on modal background
configModal.addEventListener('click', function(e) {
    if (e.target === configModal) {
        // Don't close modal on background click to prevent accidental closure
        return;
    }
});

// Optional: Allow ESC key to close modal
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && !configModal.classList.contains('hidden')) {
        configModal.classList.add('hidden');
    }
});

</script>

</body>
</html>
